---
phase: 05-game-history
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/history-db.ts
  - src/hooks/use-save-game.ts
  - src/app/results/page.tsx
autonomous: true

must_haves:
  truths:
    - "After finishing a round, the game is automatically saved to IndexedDB exactly once"
    - "History records contain date, players, numberOfHoles, rankings, winner, and full state snapshot"
    - "Saving does not trigger on re-renders or score edits — only on game completion"
  artifacts:
    - path: "src/lib/history-db.ts"
      provides: "Dexie database singleton with games table and HistoryRecord type"
      exports: ["historyDb", "HistoryRecord"]
    - path: "src/hooks/use-save-game.ts"
      provides: "Hook that saves game state to IndexedDB on completion"
      exports: ["useSaveGame"]
  key_links:
    - from: "src/hooks/use-save-game.ts"
      to: "src/lib/history-db.ts"
      via: "historyDb.games.add(record)"
      pattern: "historyDb\\.games\\.add"
    - from: "src/app/results/page.tsx"
      to: "src/hooks/use-save-game.ts"
      via: "useSaveGame() hook invocation"
      pattern: "useSaveGame\\("
---

<objective>
Install Dexie.js, declare the history database with a typed `games` table, and wire an auto-save hook into the results page that writes the completed game to IndexedDB exactly once when `isComplete` becomes true.

Purpose: Establishes the persistent history storage layer (HIST-01) so completed games survive browser restarts, cache clearing, and app updates. This is the foundation that Plan 05-02 reads from.

Output: `src/lib/history-db.ts` (Dexie singleton + HistoryRecord type), `src/hooks/use-save-game.ts` (save hook), updated `results/page.tsx` with save hook call.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-game-history/05-RESEARCH.md

Key integration points:
- `src/lib/types.ts` — imports GameConfig, HoleStrokes, PairHoleResult, PlayerHoleScore
- `src/lib/scoring.ts` — imports getFinalRankings for computing rankings at save time
- `src/lib/game-store.ts` — useGameStore provides all state needed for save (isComplete, config, holeStrokes, pairResults, playerScores)
- `src/app/results/page.tsx` — consumer of useSaveGame hook
- `src/app/layout.tsx:59-61` — navigator.storage.persist() already called on load
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Dexie and create history database module</name>
  <files>package.json, src/lib/history-db.ts</files>
  <action>
1. Install dependencies:
   ```bash
   npm install dexie dexie-react-hooks
   ```

2. Create `src/lib/history-db.ts` with:
   - Import `Dexie` and `EntityTable` from dexie
   - Import types from `./types`: `GameConfig`, `HoleStrokes`, `PairHoleResult`, `PlayerHoleScore`
   - Define and export `HistoryRecord` interface:
     ```typescript
     export interface HistoryRecord {
       id?: number;                    // Auto-incremented primary key
       completedAt: string;            // ISO 8601 date string
       players: { id: string; name: string }[];
       numberOfHoles: number;
       rankings: { playerId: string; playerName: string; totalScore: number; rank: number }[];
       winnerId: string;
       winnerName: string;
       // Full state snapshot for future detail view / stats phase
       config: GameConfig;
       holeStrokes: HoleStrokes[];
       pairResults: PairHoleResult[];
       playerScores: PlayerHoleScore[];
     }
     ```
   - Declare singleton database:
     ```typescript
     export const historyDb = new Dexie("golf-handicap-history") as Dexie & {
       games: EntityTable<HistoryRecord, "id">;
     };
     historyDb.version(1).stores({
       games: "++id, completedAt",
     });
     ```
   - Only `id` (primary key) and `completedAt` (for sort queries) are indexed. All other fields are stored but not indexed per Dexie best practices.
   - The module-level Dexie constructor is safe for SSR — it lazy-opens on first query.
  </action>
  <verify>
    - `npm ls dexie` shows dexie and dexie-react-hooks installed
    - `npx tsc --noEmit` passes with no type errors in history-db.ts
    - File exports `historyDb` and `HistoryRecord`
  </verify>
  <done>
    Dexie database singleton exists at `src/lib/history-db.ts` with a typed `games` EntityTable. The `HistoryRecord` interface captures all game state needed for history display and future stats.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useSaveGame hook and wire into results page</name>
  <files>src/hooks/use-save-game.ts, src/app/results/page.tsx</files>
  <action>
1. Create `src/hooks/use-save-game.ts`:
   - Import `useEffect`, `useRef` from react
   - Import `useGameStore` from `@/lib/game-store`
   - Import `historyDb`, `HistoryRecord` from `@/lib/history-db`
   - Import `getFinalRankings` from `@/lib/scoring`
   - Export function `useSaveGame()`:
     ```typescript
     export function useSaveGame() {
       const savedRef = useRef(false);
       const { isComplete, config, holeStrokes, pairResults, playerScores } = useGameStore();

       useEffect(() => {
         if (!isComplete || !config || savedRef.current) return;
         savedRef.current = true;

         const rankings = getFinalRankings(config.players, playerScores);
         const record: HistoryRecord = {
           completedAt: new Date().toISOString(),
           players: config.players.map(p => ({ id: p.id, name: p.name })),
           numberOfHoles: config.numberOfHoles,
           rankings: rankings.map(r => ({
             playerId: r.player.id,
             playerName: r.player.name,
             totalScore: r.totalScore,
             rank: r.rank,
           })),
           winnerId: rankings[0]?.player.id ?? "",
           winnerName: rankings[0]?.player.name ?? "",
           config,
           holeStrokes,
           pairResults,
           playerScores,
         };

         historyDb.games.add(record).catch(console.error);
       }, [isComplete]);
       // IMPORTANT: Only depend on isComplete. Do NOT add config/holeStrokes/pairResults/playerScores
       // to deps — they change on score edits, which would re-trigger the save. The useRef guard
       // provides the primary protection, but keeping deps minimal is defense-in-depth.
     }
     ```
   - The `savedRef` prevents double-save on React strict-mode double-mount or re-renders.
   - The save is fire-and-forget with `.catch(console.error)` — failure does not block the results page.

2. Update `src/app/results/page.tsx`:
   - Add import: `import { useSaveGame } from "@/hooks/use-save-game";`
   - Call `useSaveGame()` at the top of the `ResultsPage` component, right after the existing hooks (after `useGameStore()` destructure, before `useState`):
     ```typescript
     // Auto-save completed game to history (IndexedDB)
     useSaveGame();
     ```
   - No other changes to the results page.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` completes successfully
    - `npm test` — all existing tests still pass (the hook only runs client-side, tests are unaffected)
    - Manual verification: complete a game, open DevTools > Application > IndexedDB > "golf-handicap-history" > "games" — one record exists with correct data
  </verify>
  <done>
    The `useSaveGame` hook fires exactly once when a game completes, writing a full HistoryRecord to IndexedDB. The results page calls it without any UI changes. Existing tests pass unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npm ls dexie dexie-react-hooks` — both installed
2. `npx tsc --noEmit` — no type errors
3. `npm run build` — production build succeeds
4. `npm test` — all existing tests pass (no regressions)
5. Manual: Start a game, play through, complete it → check IndexedDB in DevTools for the saved record
6. Manual: Complete a second game → two records in IndexedDB, no duplicates of the first game
</verification>

<success_criteria>
- Dexie database module exists with typed HistoryRecord interface and games table
- useSaveGame hook saves the game to IndexedDB exactly once on completion
- Results page calls useSaveGame() with zero UI changes
- All existing tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-game-history/05-01-SUMMARY.md`
</output>
