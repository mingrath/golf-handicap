---
phase: 05-game-history
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/history/page.tsx
  - src/app/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a list of past rounds showing date, players, and winner"
    - "History list is sorted reverse-chronologically (newest first)"
    - "User can start a new game with the same players from their most recent round in one tap from the home screen"
    - "Play-again generates fresh player UUIDs but preserves player names and numberOfHoles"
  artifacts:
    - path: "src/app/history/page.tsx"
      provides: "History list page with date, players, and winner per game"
      min_lines: 40
    - path: "src/app/page.tsx"
      provides: "Home page with play-again button when history exists"
      contains: "Play Again"
  key_links:
    - from: "src/app/history/page.tsx"
      to: "src/lib/history-db.ts"
      via: "useLiveQuery reading historyDb.games"
      pattern: "useLiveQuery"
    - from: "src/app/page.tsx"
      to: "src/lib/history-db.ts"
      via: "historyDb.games query for latest game"
      pattern: "historyDb\\.games"
    - from: "src/app/page.tsx"
      to: "src/lib/game-store.ts"
      via: "resetGame + setPlayers + setNumberOfHoles for play-again"
      pattern: "resetGame|setPlayers|setNumberOfHoles"
---

<objective>
Create the `/history` page showing a reverse-chronological list of past rounds (date, players, winner), and add a "Play Again" button on the home page that reads the most recent game from IndexedDB and starts a new round with the same players.

Purpose: Delivers the browsing experience (HIST-02) and the quick-rematch shortcut (HIST-04) that complete the Game History feature. These are the user-facing surfaces built on top of the storage layer from Plan 05-01.

Output: `src/app/history/page.tsx` (history list), updated `src/app/page.tsx` (play-again button + history link).
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-game-history/05-RESEARCH.md
@.planning/phases/05-game-history/05-01-SUMMARY.md

Key integration points:
- `src/lib/history-db.ts` — historyDb singleton, HistoryRecord type (created in 05-01)
- `dexie-react-hooks` — useLiveQuery for reactive reads
- `src/lib/game-store.ts` — resetGame(), setPlayers(), setNumberOfHoles() for play-again flow
- `src/app/page.tsx` — existing home page with New Game / Resume Game buttons
- App design language: glass-card, slate-950 background, emerald accents, Lucide icons
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create history list page at /history</name>
  <files>src/app/history/page.tsx</files>
  <action>
1. Create `src/app/history/page.tsx` as a `"use client"` component.

2. Import `useLiveQuery` from `dexie-react-hooks`, `historyDb` and `HistoryRecord` from `@/lib/history-db`, `useRouter` from `next/navigation`, and Lucide icons (`ArrowLeft`, `Trophy`, `Calendar`, `Users`).

3. Use `useLiveQuery` to reactively read all games in reverse chronological order:
   ```typescript
   const games = useLiveQuery(
     () => historyDb.games.orderBy("completedAt").reverse().toArray(),
     [],  // deps
     []   // default value (empty array while loading)
   );
   ```

4. Layout:
   - Sticky header with back arrow (navigates to `/`) and title "Game History"
   - If `games.length === 0`: empty state card with message "No games yet. Complete a round to see it here." and a "Start a Game" button linking to `/setup`.
   - If games exist: list of game cards, each showing:
     - **Date**: Format `completedAt` using `new Date(game.completedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })` and time with `toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })`
     - **Players**: comma-separated player names (`game.players.map(p => p.name).join(", ")`)
     - **Winner**: Trophy icon + winner name + total score (from `game.rankings[0]`)
     - **Holes**: "X holes" badge
   - Each card uses the app's `glass-card` pattern with consistent spacing.

5. Style:
   - Match the app's existing dark theme: `bg-slate-950`, `glass-card`, emerald accents.
   - Winner name in `text-amber-400` (gold) with Trophy icon.
   - Date in `text-slate-400`, players in `text-slate-300`.
   - Cards should have a subtle hover state.
  </action>
  <verify>
    - `npx tsc --noEmit` — no type errors
    - `npm run build` — production build succeeds (page is prerenderable as a client component)
    - Navigate to `/history` — page renders with empty state OR list of games (depending on prior test data)
  </verify>
  <done>
    The `/history` page renders a reverse-chronological list of past games. Each entry shows the date, player names, winner with score, and hole count. Empty state guides users to start a game.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add play-again button and history link to home page</name>
  <files>src/app/page.tsx</files>
  <action>
1. Add imports to `src/app/page.tsx`:
   - `useLiveQuery` from `dexie-react-hooks`
   - `historyDb` from `@/lib/history-db`
   - `useGameStore` (already imported — add `setPlayers`, `setNumberOfHoles` to destructure)
   - `RotateCcw` and `History` from `lucide-react` (add to existing icon imports)

2. Inside `HomePage` component, query the latest game:
   ```typescript
   const latestGame = useLiveQuery(
     () => historyDb.games.orderBy("completedAt").reverse().first(),
     [],     // deps
     null    // default: null while loading
   );
   ```
   This is a progressive enhancement — the home page renders immediately with `null`, then the play-again section appears when data arrives.

3. Also destructure `setPlayers` and `setNumberOfHoles` from `useGameStore()`.

4. Create `handlePlayAgain` function:
   ```typescript
   const handlePlayAgain = () => {
     if (!latestGame) return;
     // Fresh UUIDs, same names — NEVER reuse old player IDs
     const players = latestGame.players.map(p => ({
       id: crypto.randomUUID(),
       name: p.name,
     }));
     resetGame();
     setPlayers(players);
     setNumberOfHoles(latestGame.numberOfHoles);
     router.push("/setup");
   };
   ```

5. Add UI elements after the "New Game" button (inside the `w-full max-w-sm space-y-4` div):

   a. **Play Again card** — shown only when `latestGame` is not null AND there's no active game:
   ```tsx
   {latestGame && !hasActiveGame && (
     <button
       className="w-full glass-card p-4 text-left active:scale-[0.97] transition-all group"
       onClick={handlePlayAgain}
     >
       <div className="flex items-center gap-3">
         <div className="h-10 w-10 rounded-xl bg-emerald-600/20 flex items-center justify-center">
           <RotateCcw className="h-5 w-5 text-emerald-400" />
         </div>
         <div className="flex-1 min-w-0">
           <div className="text-sm font-bold text-white">Play Again</div>
           <div className="text-xs text-slate-400 truncate">
             {latestGame.players.map(p => p.name).join(", ")} &middot; {latestGame.numberOfHoles} holes
           </div>
         </div>
       </div>
     </button>
   )}
   ```

   b. **History link** — shown when `latestGame` is not null (i.e., at least one game saved), placed after the play-again card (or after New Game if a game is active):
   ```tsx
   {latestGame && (
     <button
       className="w-full h-12 rounded-xl text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/50 transition-all flex items-center justify-center gap-2"
       onClick={() => router.push("/history")}
     >
       <History className="h-4 w-4" />
       View Game History
     </button>
   )}
   ```

6. Place the "View Game History" link BEFORE the PWA install button so install remains last.

7. The play-again card should NOT appear when `hasActiveGame` is true — the resume card takes priority in that state.
  </action>
  <verify>
    - `npx tsc --noEmit` — no type errors
    - `npm run build` — production build succeeds
    - `npm test` — all existing tests pass
    - Manual: With no history → home page shows only New Game (no play-again, no history link)
    - Manual: Complete a game → return to home → "Play Again" card shows latest game info, "View Game History" link appears
    - Manual: Tap "Play Again" → navigates to /setup with player names pre-filled
    - Manual: Tap "View Game History" → navigates to /history page
  </verify>
  <done>
    Home page shows a "Play Again" card with the most recent game's players when history exists and no active game is in progress. A "View Game History" link navigates to the history page. Play-again creates fresh player UUIDs, preserves names and numberOfHoles, and navigates to /setup.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — no type errors across the project
2. `npm run build` — production build succeeds
3. `npm test` — all existing tests pass (no regressions)
4. Navigate to `/history` — shows empty state or list of games
5. Complete a game → `/history` shows the game with date, players, winner
6. Home page shows "Play Again" card → tapping it navigates to `/setup` with correct players pre-filled
7. "View Game History" link on home navigates to `/history`
</verification>

<success_criteria>
- /history page renders a list of past games with date, players, and winner
- Home page shows play-again card when history exists and no active game
- Play-again creates fresh UUIDs, preserves names + numberOfHoles, navigates to /setup
- History link on home navigates to /history
- All existing tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-game-history/05-02-SUMMARY.md`
</output>
