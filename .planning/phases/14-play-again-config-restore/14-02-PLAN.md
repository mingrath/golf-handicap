---
phase: 14-play-again-config-restore
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/app/page.tsx
  - src/app/results/page.tsx
autonomous: false

must_haves:
  truths:
    - "Play Again on home page restores player names, hole count, AND all handicap settings (values + hole assignments)"
    - "Play Again on home page restores turbo holes exactly as configured in the previous game"
    - "Results page has a Play Again button visible in the sticky footer"
    - "Play Again from results page restores full config and navigates to /setup"
    - "After Play Again from either location, the /setup page shows restored handicap values with no manual re-entry"
    - "New Game button still exists on results page and clears config (no regression)"
  artifacts:
    - path: "src/app/page.tsx"
      provides: "Home page with fixed handlePlayAgain using usePlayAgain hook"
      contains: "usePlayAgain"
    - path: "src/app/results/page.tsx"
      provides: "Results page with Play Again button in sticky footer"
      contains: "usePlayAgain"
  key_links:
    - from: "src/app/page.tsx"
      to: "src/hooks/use-play-again.ts"
      via: "import usePlayAgain"
      pattern: "usePlayAgain"
    - from: "src/app/results/page.tsx"
      to: "src/hooks/use-play-again.ts"
      via: "import usePlayAgain"
      pattern: "usePlayAgain"
    - from: "src/app/results/page.tsx"
      to: "src/lib/history-db.ts"
      via: "useLiveQuery for latestGame"
      pattern: "useLiveQuery.*historyDb"
---

<objective>
Wire the `usePlayAgain` hook into both the home page and the results page, fixing QSET-01 and implementing QSET-02.

Purpose: Home page currently drops handicap config on Play Again (QSET-01 bug). Results page has no Play Again button at all (QSET-02 gap). Both changes use the shared hook from plan 01.

Output: Modified `src/app/page.tsx` and `src/app/results/page.tsx`, plus a human verification checkpoint.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/page.tsx
@src/app/results/page.tsx
@src/hooks/use-play-again.ts
@src/lib/history-db.ts
@.planning/phases/14-play-again-config-restore/14-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix handlePlayAgain on home page (QSET-01)</name>
  <files>src/app/page.tsx</files>
  <action>
    Replace the inline `handlePlayAgain` function with a call to the `usePlayAgain` hook.

    Changes to make in `src/app/page.tsx`:

    1. Add import at top (alongside existing imports):
       ```typescript
       import { usePlayAgain } from "@/hooks/use-play-again";
       ```

    2. Remove these store destructures from `useGameStore()` (no longer used directly in handlePlayAgain):
       - `setPlayers`
       - `setNumberOfHoles`
       Keep `resetGame` because `handleNewGame` still calls `resetGame()` directly.

    3. Replace the existing `handlePlayAgain` function (lines 65-76) with a single line:
       ```typescript
       const handlePlayAgain = usePlayAgain();
       ```
       The hook returns a function with signature `(latestGame: HistoryRecord | null | undefined) => void`.

    4. Update the JSX onClick for the Play Again card (currently `onClick={handlePlayAgain}`) to pass latestGame:
       ```tsx
       onClick={() => handlePlayAgain(latestGame)}
       ```

    IMPORTANT: Do not remove `latestGame` (still needed for card display and conditional rendering). Do not remove `resetGame` (still used in `handleNewGame`). Do not change any UI JSX beyond updating the onClick handler.

    After the change, the home page `useGameStore` destructure should be:
    ```typescript
    const {
      config,
      holeStrokes,
      currentHole,
      isComplete,
      resetGame,
    } = useGameStore();
    ```
    (setPlayers and setNumberOfHoles removed since the hook handles them internally.)
  </action>
  <verify>
    `npx tsc --noEmit` exits 0.
    `npm test` passes (all tests green).
    `grep -n "setPlayers\|setNumberOfHoles" src/app/page.tsx` returns no matches (those calls moved into the hook).
    `grep -n "usePlayAgain" src/app/page.tsx` returns a match.
  </verify>
  <done>
    `src/app/page.tsx` imports `usePlayAgain`, `handlePlayAgain` is a single line calling the hook, onClick passes `latestGame`, TypeScript compiles clean, all tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Play Again button to results page (QSET-02)</name>
  <files>src/app/results/page.tsx</files>
  <action>
    Add `useLiveQuery` for `latestGame` and a "Play Again" button to the results page sticky footer.

    Changes to make in `src/app/results/page.tsx`:

    1. Add to the existing lucide-react import line — add `RefreshCcw`:
       ```typescript
       import { Home, RotateCcw, RefreshCcw, Pencil, X, TableProperties } from "lucide-react";
       ```
       Note: `RotateCcw` is already imported for "New Game". Use `RefreshCcw` for "Play Again" (visually distinct, exists in lucide-react).

    2. Add new imports (after existing imports):
       ```typescript
       import { useLiveQuery } from "dexie-react-hooks";
       import { historyDb } from "@/lib/history-db";
       import { usePlayAgain } from "@/hooks/use-play-again";
       ```

    3. Add inside the component body (after the `useSaveGame()` call):
       ```typescript
       const latestGame = useLiveQuery(
         () => historyDb.games.orderBy("completedAt").reverse().first(),
         [],
         null
       );
       const handlePlayAgain = usePlayAgain();
       ```

    4. Replace the existing sticky footer (currently `flex gap-3` with Home + New Game) with a 3-button layout:
       ```tsx
       <div className="sticky bottom-0 p-4 pb-safe bg-background/90 backdrop-blur-xl border-t border-border flex gap-3">
         <button
           className="h-14 w-14 rounded-xl text-lg font-semibold bg-muted border border-border text-muted-foreground hover:bg-muted/80 active:scale-[0.97] transition-all flex items-center justify-center"
           onClick={handleGoHome}
           aria-label="Home"
         >
           <Home className="h-5 w-5" />
         </button>
         <button
           className="flex-1 h-14 rounded-xl text-lg font-bold bg-gradient-to-r from-emerald-600 to-teal-500 text-white shadow-lg shadow-emerald-600/25 active:scale-[0.97] transition-all flex items-center justify-center gap-2"
           onClick={() => handlePlayAgain(latestGame)}
         >
           <RefreshCcw className="h-5 w-5" />
           Play Again
         </button>
         <button
           className="flex-1 h-14 rounded-xl text-lg font-semibold bg-muted border border-border text-muted-foreground hover:bg-muted/80 active:scale-[0.97] transition-all flex items-center justify-center gap-2"
           onClick={handleNewGame}
         >
           <RotateCcw className="h-5 w-5" />
           New Game
         </button>
       </div>
       ```

       Layout rationale:
       - Home becomes icon-only square (h-14 w-14) — saves horizontal space
       - Play Again gets `flex-1` with primary emerald gradient — most likely repeat action
       - New Game gets `flex-1` with muted style — blank-slate option, still reachable
       - Play Again is always visible (not conditional): the results page IS the just-finished game, so `latestGame` resolves immediately after `useSaveGame` fires. If null edge case occurs, the hook is internally a no-op.

    5. The existing `handleNewGame` function (`resetGame()` + `router.push("/setup")`) — leave it exactly as is.

    IMPORTANT: Only add imports, 2 hook lines, and replace the footer JSX. Do not modify any other part of the results page.
  </action>
  <verify>
    `npx tsc --noEmit` exits 0.
    `npm test` passes (all tests green).
    `grep -n "usePlayAgain\|useLiveQuery\|RefreshCcw" src/app/results/page.tsx` returns matches for all three.
    `grep -n "Play Again" src/app/results/page.tsx` returns a match.
  </verify>
  <done>
    Results page imports `useLiveQuery`, `historyDb`, `usePlayAgain`, and `RefreshCcw`. Footer has 3 buttons: Home (icon-only), Play Again (flex-1 gradient), New Game (flex-1 muted). TypeScript compiles clean. All tests pass.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify full Play Again config restore on device</name>
  <action>Human verification of the completed Play Again feature on the running dev server.</action>
  <verify>N/A — this is a manual verification checkpoint. See how-to-verify below.</verify>
  <done>User confirms both QSET-01 and QSET-02 work correctly and types "approved".</done>
  <what-built>
    - Fixed `handlePlayAgain` on home page now restores full handicap config (values + hole assignments + turbo holes) using the shared `usePlayAgain` hook (QSET-01)
    - Results page has a new 3-button sticky footer with Play Again button that restores full config from the just-completed game (QSET-02)
  </what-built>
  <how-to-verify>
    Run `npm run dev` (server at http://localhost:3000).

    Test QSET-01 — home page Play Again restores full config:
    1. Start a new game with 2+ players (e.g., Alice and Bob)
    2. Configure at least one non-zero handicap (e.g., Alice gives 2 strokes to Bob)
    3. Optionally set a turbo hole
    4. Complete the game (enter strokes for all holes, reach results page)
    5. From the results page, tap Home
    6. On the home page, tap "Play Again"
    7. On /setup: verify player names are pre-filled and hole count is pre-filled
    8. Open the handicap configuration section: verify the handicap value is present for Alice-Bob (e.g., "2 strokes")
    9. Verify handicap hole assignments are restored (e.g., "2/2 selected" not "0/2 selected")
    10. If turbo holes were set, verify they are also pre-selected

    Test QSET-02 — results page Play Again:
    1. Complete a game with configured handicaps
    2. On the results page, verify the sticky footer shows 3 buttons: Home (icon only), Play Again (green gradient), New Game (muted)
    3. Tap "Play Again" from the results page
    4. Verify /setup page shows restored config with handicaps (same checks as QSET-01)

    Test regression — New Game still clears config:
    1. From results page, tap "New Game"
    2. Verify setup page opens with blank state (no pre-filled players or handicaps)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` exits 0 (no TypeScript errors)
- `npm test` passes (all 112+ tests green)
- Manual verification via checkpoint confirms QSET-01 and QSET-02 both work correctly
- `grep -rn "usePlayAgain" src/app/page.tsx src/app/results/page.tsx` returns matches in both files
</verification>

<success_criteria>
1. "Play Again" on home page restores player names, hole count, AND all handicap settings — verified manually on /setup page after clicking Play Again
2. Results page has a "Play Again" button in the sticky footer that also restores full config
3. After tapping "Play Again" from either location, setup page reflects restored config with no manual re-entry required
4. "New Game" on results page still clears everything (no regression)
5. All 112+ existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-play-again-config-restore/14-02-SUMMARY.md`
</output>
