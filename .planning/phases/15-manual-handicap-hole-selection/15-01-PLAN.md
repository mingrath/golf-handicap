---
phase: 15-manual-handicap-hole-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/shared/handicap-edit-dialog.tsx
autonomous: false

must_haves:
  truths:
    - "When user opens the handicap edit dialog during play or on results, they see which holes currently have handicap strokes for each pair"
    - "User can tap individual holes to toggle handicap strokes on or off for a pair, overriding the auto-distribution"
    - "When user changes the handicap value via the stepper, existing hole selections are preserved and user can manually add/remove the difference"
    - "Manual hole selections persist through score replay -- all pair results recalculate correctly using user-chosen handicap holes"
  artifacts:
    - path: "src/components/shared/handicap-edit-dialog.tsx"
      provides: "Enhanced HandicapEditDialog with inline hole toggle grid per pair"
      contains: "handicapHoles"
  key_links:
    - from: "src/components/shared/handicap-edit-dialog.tsx"
      to: "useGameStore.setHandicapHoles"
      via: "toggle button onClick calling setHandicapHoles with updated array"
      pattern: "setHandicapHoles\\(pair\\.pairKey"
    - from: "src/components/shared/handicap-edit-dialog.tsx"
      to: "useGameStore.recalculateFromStrokes"
      via: "handleClose calls recalculateFromStrokes when scores exist"
      pattern: "recalculateFromStrokes"
---

<objective>
Add manual handicap hole selection to the HandicapEditDialog component so users can see and control which specific holes receive handicap strokes when editing a pair's handicap during play or on the results page.

Purpose: Currently the HandicapEditDialog only has a NumberStepper and auto-distributes holes when value changes. Users need to see current hole assignments and manually toggle them, matching the UI already present on the /handicap setup page. This fulfills HCTL-01, HCTL-02, and HCTL-03.

Output: Enhanced HandicapEditDialog with inline hole toggle grid per pair card.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/shared/handicap-edit-dialog.tsx
@src/app/handicap/page.tsx
@src/lib/game-store.ts
@src/lib/types.ts
@src/lib/pairs.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance HandicapEditDialog with hole toggle grid</name>
  <files>src/components/shared/handicap-edit-dialog.tsx</files>
  <action>
Rewrite HandicapEditDialog to add inline handicap hole selection below each pair's NumberStepper, closely matching the proven UI pattern from `/handicap/page.tsx`. The component is ~100 lines today; it will grow to ~170-200 lines.

**Keep unchanged:**
- Dialog open/close state management
- DialogTrigger (the Settings2 icon button)
- DialogContent with max-h-[80dvh] overflow-y-auto
- DialogHeader with "Edit Handicaps" title
- The note "Changes will recalculate all scores"
- The glass-card wrapper per pair
- The pair name display (playerAName vs playerBName)
- The existing handicap direction description ("X gives N strokes")
- NumberStepper with same min/max/size props

**Modify handleHandicapChange behavior (HCTL-03):**
The current function auto-distributes holes every time the value changes. Replace with smarter logic:

1. When value increases (e.g., 3 to 5): Keep existing handicapHoles intact. Do NOT auto-distribute. The user now has 3 selected but needs 5 -- they manually pick 2 more holes. This is the core HCTL-03 requirement.

2. When value decreases (e.g., 5 to 3): Keep as many existing selections as possible. If current selections exceed new abs(value), trim from the end (highest hole numbers first) to match. This prevents "losing all selections" on a small adjustment.

3. When value goes to 0: Clear handicapHoles to [].

4. When value changes sign (e.g., +3 to -2): Clear existing handicapHoles since the direction changed entirely.

5. When value is set from 0 to non-zero: Auto-distribute using `distributeHandicapHoles()` as a starting point (same as today), giving the user a sensible default they can then adjust.

Implementation:
```typescript
const handleHandicapChange = (pairKey: string, newValue: number) => {
  const existing = config.handicaps[pairKey];
  const oldValue = existing?.value ?? 0;
  const oldHoles = existing?.handicapHoles ?? [];

  setHandicap(pairKey, newValue);
  // setHandicap resets handicapHoles to [] internally, so we must call setHandicapHoles after

  if (newValue === 0) {
    // No holes needed
    return;
  }

  const signChanged = (oldValue > 0 && newValue < 0) || (oldValue < 0 && newValue > 0);

  if (oldValue === 0 || signChanged) {
    // Fresh start: auto-distribute as default
    const holes = distributeHandicapHoles(newValue, config.numberOfHoles);
    setHandicapHoles(pairKey, holes);
  } else {
    // Same direction, value changed
    const absNew = Math.abs(newValue);
    if (oldHoles.length <= absNew) {
      // Value increased or same: keep all existing selections
      setHandicapHoles(pairKey, oldHoles);
    } else {
      // Value decreased: trim from highest hole numbers
      const trimmed = [...oldHoles].sort((a, b) => a - b).slice(0, absNew);
      setHandicapHoles(pairKey, trimmed);
    }
  }
};
```

**Add hole toggle grid below NumberStepper for each pair (HCTL-01, HCTL-02):**

When `Math.abs(value) > 0`, render a hole selection section below the NumberStepper. Copy the exact UI pattern from `/handicap/page.tsx` lines 92-142:

- Label: "Handicap holes (tap to toggle):"
- Flex-wrap grid of hole buttons (1 to numberOfHoles)
- Selected holes: `bg-emerald-500 text-white shadow-lg shadow-emerald-500/25`
- Unselected available: `bg-muted text-muted-foreground hover:bg-muted/80 border border-border`
- Disabled (at max): `bg-muted/30 text-muted-foreground/40`
- Button size: `w-9 h-9 rounded-lg text-xs font-bold transition-all active:scale-90`
- Selection counter: `{selected}/{required} selected` with rose-400 warning when incomplete

Toggle logic (same as /handicap page):
- If hole is selected: remove from array via filter
- If hole is not selected and not at max: add to array
- Max selectable = Math.abs(value)
- atMax = handicapHoles.length >= maxSelectable && !isSelected

Wire toggles to `setHandicapHoles(pairKey, updatedHoles)` directly -- no local state needed since the store is the source of truth and the component re-renders on store changes.

**Important implementation note:** Read `handicapHoles` from `config.handicaps[pair.pairKey]?.handicapHoles ?? []` inside the map, NOT from a stale closure. The component reads from store on each render.

**Do NOT add:**
- A "Done" button or footer (the existing dialog close handles recalculation)
- Any incomplete-pair blocking logic (unlike the setup page, editing during play should not block)
- Any new store actions or types
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Run `npm test` to confirm existing 118 tests still pass. Manually verify the component renders by checking no import errors.
  </verify>
  <done>
HandicapEditDialog shows a hole toggle grid below each pair's NumberStepper when handicap value is non-zero. Users can see current selections (HCTL-01), tap to toggle individual holes (HCTL-02), and changing the value preserves existing selections while allowing manual adjustment (HCTL-03). All scores recalculate on dialog close via existing recalculateFromStrokes call.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify manual handicap hole selection on play and results pages</name>
  <files>src/components/shared/handicap-edit-dialog.tsx</files>
  <action>
Human verifies the enhanced HandicapEditDialog works correctly during play and on results.
  </action>
  <verify>
    1. Run `npm run dev` and start a new game with 3+ players, 9 or 18 holes
    2. On setup, go to Handicaps and set at least one pair to handicap 3. Select specific holes. Start the game.
    3. During play, tap the Settings2 (gear) icon in the header to open HandicapEditDialog
    4. Verify HCTL-01: You can see which holes are highlighted green for each pair with a handicap
    5. Verify HCTL-02: Tap an unselected hole -- it turns green. Tap a selected hole -- it deselects. Cannot select more than abs(value) holes.
    6. Verify HCTL-03: Change the handicap value from 3 to 5 using the stepper. Confirm the 3 previously selected holes remain selected, and you can now pick 2 more. Change from 5 to 2 -- only 2 holes remain (highest trimmed).
    7. Close the dialog and verify scores on the leaderboard reflect the hole changes
    8. Complete the game and verify the same dialog works on the results page
    9. On results, change a handicap and verify all scores/rankings/charts update correctly
  </verify>
  <done>User confirms all HCTL requirements work correctly on both play and results pages.</done>
</task>

</tasks>

<verification>
- `npm run build` passes with no errors
- `npm test` passes all 118 existing tests
- HandicapEditDialog renders hole toggle grid when handicap value != 0
- Hole toggles update store via setHandicapHoles
- Value changes preserve existing selections (HCTL-03 smart logic)
- Dialog close triggers recalculateFromStrokes when scores exist
- No new store actions or type changes required
</verification>

<success_criteria>
1. Opening HandicapEditDialog shows current handicap hole assignments per pair (HCTL-01)
2. Tapping holes toggles them on/off within the max allowed by handicap value (HCTL-02)
3. Changing handicap value preserves existing selections and lets user adjust the difference (HCTL-03)
4. Closing dialog after changes recalculates all scores correctly (replay engine)
5. Works identically on both play page and results page
6. Build passes, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-manual-handicap-hole-selection/15-01-SUMMARY.md`
</output>
