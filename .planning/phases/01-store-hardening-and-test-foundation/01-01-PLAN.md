---
phase: 01-store-hardening-and-test-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/game-store.ts
  - src/lib/types.ts
  - src/app/setup/page.tsx
  - src/app/handicap/page.tsx
  - src/app/layout.tsx
  - src/components/shared/hydration-gate.tsx
  - src/components/ui/sonner.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Invalid stroke values (negative, >20, non-integer) are rejected by the store before persisting"
    - "Invalid handicap values (exceeding hole count) are rejected by the store"
    - "Setting more than 6 or fewer than 2 players is rejected by the store"
    - "Player IDs are cryptographic UUIDs, not Math.random() strings"
    - "verifyZeroSum() is called after every score submission"
    - "Persisted state includes version: 1 with a cascading migrate function"
    - "App shows a branded loading screen (logo + spinner) until store hydrates"
    - "Navigating to /setup does NOT reset an active game"
    - "Toast notifications appear for validation failures"
  artifacts:
    - path: "src/lib/game-store.ts"
      provides: "Hardened store with validation, versioning, hydration hooks"
      contains: "version: 1"
    - path: "src/components/shared/hydration-gate.tsx"
      provides: "Branded loading screen during hydration"
      contains: "HydrationGate"
    - path: "src/components/ui/sonner.tsx"
      provides: "Toast notification component"
      contains: "Toaster"
  key_links:
    - from: "src/lib/game-store.ts"
      to: "sonner"
      via: "toast() calls in validation guards"
      pattern: "toast\\.warning"
    - from: "src/app/layout.tsx"
      to: "src/components/shared/hydration-gate.tsx"
      via: "HydrationGate wrapping children"
      pattern: "HydrationGate"
    - from: "src/app/layout.tsx"
      to: "src/components/ui/sonner.tsx"
      via: "Toaster component in body"
      pattern: "Toaster"
    - from: "src/lib/game-store.ts"
      to: "zustand persist"
      via: "version + migrate config"
      pattern: "version.*migrate"
---

<objective>
Harden the Zustand game store with input validation, state versioning, cryptographic IDs, zero-sum verification, hydration guard, and fix the setup page reset bug.

Purpose: Make the state layer trustworthy so all subsequent phases build on validated, versioned, safely-persisted data. This is the foundation phase — nothing ships without store integrity.
Output: Hardened game-store.ts, hydration gate component, sonner toast integration, fixed setup page, dynamic handicap range.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-store-hardening-and-test-foundation/01-RESEARCH.md
@.planning/phases/01-store-hardening-and-test-foundation/01-CONTEXT.md
@src/lib/game-store.ts
@src/lib/scoring.ts
@src/lib/pairs.ts
@src/lib/types.ts
@src/app/setup/page.tsx
@src/app/handicap/page.tsx
@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sonner and create hydration gate</name>
  <files>
    package.json
    src/components/ui/sonner.tsx
    src/components/shared/hydration-gate.tsx
    src/app/layout.tsx
  </files>
  <action>
1. Install sonner via shadcn CLI:
   ```bash
   npx shadcn@latest add sonner
   ```
   This auto-generates `src/components/ui/sonner.tsx` with theme integration.

2. Create `src/components/shared/hydration-gate.tsx` — a client component that:
   - Subscribes to `useGameStore.persist.onFinishHydration()` in a useEffect
   - Also checks `useGameStore.persist.hasHydrated()` immediately (handles already-hydrated case)
   - Sets a `hydrated` state to true when hydration completes
   - Adds a 200ms safety timeout — if hydration hasn't completed by then, shows recovery options (a "Something went wrong — tap to reset" message that clears localStorage and reloads)
   - While not hydrated, renders: centered golf flag emoji (⛳, `&#9971;`), a CSS-only spinner (Tailwind `animate-spin` on a bordered div with `border-emerald-500 border-t-transparent`), dark background `bg-slate-950`
   - Per user decision: NO skeleton layout, just branded loading screen with logo + spinner
   - When hydrated, renders `{children}`

3. Modify `src/app/layout.tsx`:
   - Import `Toaster` from `@/components/ui/sonner`
   - Import `HydrationGate` from `@/components/shared/hydration-gate`
   - Wrap `{children}` with `<HydrationGate>` inside the body
   - Add `<Toaster position="top-center" richColors />` inside the body, OUTSIDE the HydrationGate (so toasts work even during hydration for corruption warnings)
   - layout.tsx is a server component, so HydrationGate must be a separate client component (it uses hooks)
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors. Verify `src/components/ui/sonner.tsx` exists (created by shadcn CLI). Verify `src/components/shared/hydration-gate.tsx` exists. Verify `src/app/layout.tsx` includes both `<HydrationGate>` and `<Toaster>`.
  </verify>
  <done>
    Sonner toast system is available app-wide. Hydration gate shows branded loading screen until store rehydrates. Layout wires both components.
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden game store with validation, versioning, crypto IDs, zero-sum, and fix setup reset</name>
  <files>
    src/lib/game-store.ts
    src/app/setup/page.tsx
    src/app/handicap/page.tsx
  </files>
  <action>
1. **Harden `src/lib/game-store.ts`:**

   a. **Add validation to `setPlayers()`** (FOUN-03):
      - Check `players.length >= 2 && players.length <= 6`
      - If invalid, call `toast.warning("Player count must be between 2 and 6")` and return `{}`
      - Import `toast` from `"sonner"` at top of file (not a hook — works anywhere)

   b. **Add validation to `submitHoleStrokes()`** (FOUN-01, FOUN-02, FOUN-05):
      - Before processing, validate each stroke value: `value >= 0 && value <= 20 && Number.isInteger(value)`
      - If any stroke is invalid, call `toast.warning("Stroke values must be whole numbers between 0 and 20")` and return `{}`
      - Validate `strokes.holeNumber >= 1 && strokes.holeNumber <= state.config.numberOfHoles`
      - If hole number invalid, call `toast.warning("Invalid hole number")` and return `{}`
      - After calculating `newPlayerScores` (the scores for this hole), call `verifyZeroSum(newPlayerScores)` — import it from `@/lib/scoring`
      - If verifyZeroSum returns false, call `console.warn("Zero-sum verification failed for hole", holeNumber)` and `toast.warning("Score verification warning: scores may not balance correctly")` — still persist the results (don't block gameplay, just warn)

   c. **Add validation to `setHandicap()`** (FOUN-02):
      - Validate `Math.abs(value) <= state.config.numberOfHoles`
      - If invalid, call `toast.warning("Handicap cannot exceed the number of holes")` and return `{}`
      - Also validate `Number.isInteger(value)` — reject non-integers

   d. **Add validation to `setNumberOfHoles()`**:
      - Validate `n >= 1 && n <= 36 && Number.isInteger(n)`
      - If invalid, return `{}` (no toast needed — UI NumberStepper already constrains)

   e. **Add state versioning** (FOUN-06):
      - Add `version: 1` to the persist config object (second argument to `persist()`)
      - Add `migrate` function with cascading `if (version < N)` pattern:
        ```typescript
        migrate: (persistedState: unknown, version: number) => {
          if (version < 1) {
            // v0 (unversioned v1 data) -> v1: clean slate per user decision
            return { ...initialState };
          }
          // Future: if (version < 2) { ... }
          return persistedState as GameState;
        },
        ```
      - Add `onRehydrateStorage` callback:
        - On error: `toast.error("Game data was corrupted. Starting fresh.")` and return initial state
        - On success: no action needed (HydrationGate handles the UI)

   f. **Wire verifyZeroSum import**: Add `verifyZeroSum` to the import from `"./scoring"`

2. **Fix `src/app/setup/page.tsx`** (FOUN-04, FOUN-10):

   a. **Replace `generateId()` with `crypto.randomUUID()`** (FOUN-04):
      - Delete the `generateId()` function entirely
      - Replace all calls: `generateId()` → `crypto.randomUUID()`
      - This includes the initial state `useState<Player[]>()` and the `addPlayer()` function

   b. **Remove the setup reset bug** (FOUN-10):
      - DELETE the entire `useEffect(() => { resetGame(); }, [])` block (lines 34-37)
      - The `resetGame()` call already happens on the home page in `handleNewGame()` (line 40-43 of `src/app/page.tsx`) and in the results page's `handleNewGame()` — setup page should NOT reset
      - Remove `resetGame` from the destructured `useGameStore()` call (it's no longer used on this page)

3. **Fix `src/app/handicap/page.tsx`** (FOUN-02):

   a. **Dynamic handicap range**: Change the NumberStepper on line 88-93:
      - Replace `min={-18}` with `min={-config.numberOfHoles}`
      - Replace `max={18}` with `max={config.numberOfHoles}`
      - This ensures handicap can never exceed the hole count per user decision
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors.

    Verify in `src/lib/game-store.ts`:
    - `import { toast } from "sonner"` exists
    - `import { ... verifyZeroSum } from "./scoring"` exists
    - `version: 1` in persist config
    - `migrate` function in persist config
    - `onRehydrateStorage` in persist config
    - Validation checks in `setPlayers`, `submitHoleStrokes`, `setHandicap`, `setNumberOfHoles`

    Verify in `src/app/setup/page.tsx`:
    - No `generateId` function
    - `crypto.randomUUID()` used instead
    - No `useEffect(() => { resetGame(); }, [])` block
    - No `resetGame` in the useGameStore destructure

    Verify in `src/app/handicap/page.tsx`:
    - `min={-config.numberOfHoles}` and `max={config.numberOfHoles}` on NumberStepper
  </verify>
  <done>
    Store rejects invalid strokes (0-20), invalid handicaps (exceeding holes), invalid player counts (2-6). Player IDs use crypto.randomUUID(). verifyZeroSum() runs after every score submission. State versioned at v1 with cascading migration. Setup page no longer wipes active games. Handicap range is dynamic.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds with no errors
2. Grep for `Math.random` in src/ — should return NO results
3. Grep for `version: 1` in game-store.ts — should exist
4. Grep for `verifyZeroSum` in game-store.ts — should exist (imported and called)
5. Grep for `toast.warning` in game-store.ts — should exist (validation feedback)
6. Grep for `resetGame` in setup/page.tsx — should NOT exist
7. Grep for `crypto.randomUUID` in setup/page.tsx — should exist
8. Grep for `HydrationGate` in layout.tsx — should exist
9. Grep for `Toaster` in layout.tsx — should exist
10. Grep for `min={-18}` in handicap/page.tsx — should NOT exist (replaced with dynamic)
</verification>

<success_criteria>
- Build passes with zero TypeScript errors
- Store has validation guards on setPlayers, submitHoleStrokes, setHandicap, setNumberOfHoles
- State is versioned with version: 1 and a migrate function
- Hydration gate renders branded loading screen before store is ready
- Toast notifications are wired for validation warnings
- Setup page uses crypto.randomUUID() and does NOT reset game on mount
- Handicap page uses dynamic min/max based on hole count
</success_criteria>

<output>
After completion, create `.planning/phases/01-store-hardening-and-test-foundation/01-01-SUMMARY.md`
</output>
