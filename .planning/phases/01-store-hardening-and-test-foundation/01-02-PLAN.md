---
phase: 01-store-hardening-and-test-foundation
plan: 02
type: tdd
wave: 2
depends_on: ["01-01"]
files_modified:
  - vitest.config.mts
  - package.json
  - src/lib/__tests__/scoring.test.ts
  - src/lib/__tests__/pairs.test.ts
  - src/lib/__tests__/game-store.test.ts
autonomous: true

must_haves:
  truths:
    - "All pure functions in scoring.ts have passing Vitest tests covering normal and edge cases"
    - "All pure functions in pairs.ts have passing Vitest tests covering normal and edge cases"
    - "Store actions (submitHoleStrokes, setHandicap, setPlayers, resetGame) have integration tests"
    - "Edge cases are covered: 6 players x 36 holes, all ties, max handicap, turbo on every hole"
    - "Pre-commit hook runs tests before every commit"
    - "npx vitest run passes with all tests green"
  artifacts:
    - path: "vitest.config.mts"
      provides: "Vitest configuration with React plugin and path aliases"
      contains: "defineConfig"
    - path: "src/lib/__tests__/scoring.test.ts"
      provides: "Tests for calculatePairHoleResult, calculatePlayerHoleScores, verifyZeroSum, getRunningTotals, getFinalRankings, getHandicapAdjustment"
      contains: "describe"
    - path: "src/lib/__tests__/pairs.test.ts"
      provides: "Tests for generatePairs, makePairKey, parsePairKey, distributeHandicapHoles, getPlayerName"
      contains: "describe"
    - path: "src/lib/__tests__/game-store.test.ts"
      provides: "Integration tests for store validation and actions"
      contains: "describe"
  key_links:
    - from: "src/lib/__tests__/scoring.test.ts"
      to: "src/lib/scoring.ts"
      via: "direct import of pure functions"
      pattern: "import.*from.*scoring"
    - from: "src/lib/__tests__/pairs.test.ts"
      to: "src/lib/pairs.ts"
      via: "direct import of pure functions"
      pattern: "import.*from.*pairs"
    - from: "src/lib/__tests__/game-store.test.ts"
      to: "src/lib/game-store.ts"
      via: "import useGameStore for integration tests"
      pattern: "import.*from.*game-store"
    - from: "package.json"
      to: "vitest"
      via: "test script and simple-git-hooks config"
      pattern: "vitest run"
---

<objective>
Set up Vitest test infrastructure and write comprehensive tests for all pure scoring functions, pair generation functions, and store action validation.

Purpose: Prove the hardened store (from Plan 01-01) works correctly. Tests are the safety net that catches regressions as future phases modify scoring, pairing, and store logic. Pre-commit hook ensures tests run before every commit.
Output: vitest.config.mts, three test files with full coverage, pre-commit hook via simple-git-hooks.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-store-hardening-and-test-foundation/01-RESEARCH.md
@.planning/phases/01-store-hardening-and-test-foundation/01-CONTEXT.md
@.planning/phases/01-store-hardening-and-test-foundation/01-01-SUMMARY.md
@src/lib/scoring.ts
@src/lib/pairs.ts
@src/lib/types.ts
@src/lib/game-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Vitest and write scoring.ts + pairs.ts tests</name>
  <files>
    vitest.config.mts
    package.json
    src/lib/__tests__/scoring.test.ts
    src/lib/__tests__/pairs.test.ts
  </files>
  <action>
1. **Install test dependencies:**
   ```bash
   npm install -D vitest @vitejs/plugin-react vite-tsconfig-paths jsdom
   ```

2. **Create `vitest.config.mts`** at project root:
   ```typescript
   import { defineConfig } from "vitest/config";
   import react from "@vitejs/plugin-react";
   import tsconfigPaths from "vite-tsconfig-paths";

   export default defineConfig({
     plugins: [tsconfigPaths(), react()],
     test: {
       environment: "jsdom",
       include: ["src/**/*.test.{ts,tsx}"],
     },
   });
   ```

3. **Add test script to `package.json`:**
   - Add `"test": "vitest run"` to the `scripts` section
   - Add `"test:watch": "vitest"` for development convenience

4. **Create `src/lib/__tests__/scoring.test.ts`** with full coverage:

   Import all functions: `getHandicapAdjustment`, `calculatePairHoleResult`, `calculatePlayerHoleScores`, `verifyZeroSum`, `getRunningTotals`, `getFinalRankings` from `@/lib/scoring`.
   Import types: `PairHandicap`, `HoleStrokes`, `PairHoleResult`, `PlayerHoleScore`, `Player` from `@/lib/types`.

   **Test suites to write:**

   a. `describe("getHandicapAdjustment")`:
      - No adjustment when hole is not a handicap hole
      - playerB gets -1 when handicap is positive and hole is a handicap hole
      - playerA gets -1 when handicap is negative and hole is a handicap hole
      - No adjustment when handicap value is 0 even if hole is listed

   b. `describe("calculatePairHoleResult")`:
      - Awards +1 to lower scorer, -1 to higher scorer (basic case, no handicap)
      - Tie returns 0/0
      - Turbo hole doubles scores (+2/-2)
      - Turbo tie is still 0/0
      - Handicap adjustment flips the result (e.g., A scores 4, B scores 5, but B gets -1 adjustment → 4 vs 4 → tie)
      - Scores default to 0 when player ID is missing from strokes (defensive)
      - Edge case: both players score 0 strokes → tie

   c. `describe("calculatePlayerHoleScores")`:
      - Two players: scores match pair result directly
      - Three players: each player's score is sum of their two pair results
      - Four players: verify sum of all player scores is 0 (zero-sum)
      - Running total accumulates from previousTotals correctly
      - Edge case: 6 players, verify zero-sum holds

   d. `describe("verifyZeroSum")`:
      - Returns true when scores sum to zero (basic case)
      - Returns false when scores don't sum to zero
      - Returns true for empty array (vacuously true)
      - Returns true for single-player (degenerate case)
      - Edge case: large positive and negative scores that cancel out

   e. `describe("getRunningTotals")`:
      - Returns totals up to specified hole
      - Excludes holes after the cutoff
      - Returns empty object for no scores
      - Accumulates multiple holes correctly
      - Edge case: upToHole = 0 returns empty

   f. `describe("getFinalRankings")`:
      - Ranks players by total score (highest first)
      - Handles ties with same rank number (e.g., two players tied at rank 1, next is rank 3)
      - All tied players get rank 1
      - Single player gets rank 1
      - Edge case: all negative scores, highest negative wins

5. **Create `src/lib/__tests__/pairs.test.ts`** with full coverage:

   Import: `makePairKey`, `parsePairKey`, `generatePairs`, `getPlayerName`, `distributeHandicapHoles` from `@/lib/pairs`.
   Import types: `Player` from `@/lib/types`.

   **Test suites to write:**

   a. `describe("makePairKey")`:
      - Sorts IDs alphabetically and joins with `::`
      - Same result regardless of argument order (commutative)
      - Works with UUID-format IDs
      - Edge case: identical IDs (degenerate)

   b. `describe("parsePairKey")`:
      - Splits pair key back into two IDs
      - Round-trips with makePairKey: `parsePairKey(makePairKey(a, b))` returns sorted `[a, b]`

   c. `describe("generatePairs")`:
      - 2 players → 1 pair (C(2,2) = 1)
      - 3 players → 3 pairs (C(3,2) = 3)
      - 4 players → 6 pairs (C(4,2) = 6)
      - 5 players → 10 pairs
      - 6 players → 15 pairs (max C(6,2) = 15)
      - Each pair has consistent pairKey (alphabetically sorted)
      - All pairs are unique (no duplicates)
      - Empty players → empty result
      - Single player → empty result (can't make a pair)

   d. `describe("getPlayerName")`:
      - Returns player name when found
      - Returns playerId as fallback when not found

   e. `describe("distributeHandicapHoles")`:
      - Zero handicap → empty array
      - Handicap of 1 over 18 holes → 1 hole selected (hole 1)
      - Handicap equal to hole count → all holes selected
      - Handicap exceeding hole count → all holes selected (capped)
      - Even distribution: 9 handicap over 18 holes → holes are spaced evenly
      - Negative handicap treated as absolute value (same distribution)
      - Edge case: 0 holes → empty array
      - Edge case: 36 holes, handicap 36 → all 36 holes

6. **Run tests:** `npx vitest run` — ALL tests must pass.
  </action>
  <verify>
    `npx vitest run` passes with 0 failures. Verify test count is reasonable (40+ individual test cases across scoring and pairs). Verify all describe blocks exist in both test files.
  </verify>
  <done>
    Vitest configured with React and path alias support. All pure functions in scoring.ts and pairs.ts have comprehensive tests covering normal cases, edge cases, ties, max player/hole counts, and zero-sum verification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write store integration tests and set up pre-commit hook</name>
  <files>
    src/lib/__tests__/game-store.test.ts
    package.json
  </files>
  <action>
1. **Create `src/lib/__tests__/game-store.test.ts`** with integration tests:

   Import `useGameStore` from `@/lib/game-store`.
   Import `describe, it, expect, beforeEach, vi` from `vitest`.

   **Setup:** In `beforeEach`:
   - Call `useGameStore.getState().resetGame()` to reset store state
   - Call `localStorage.clear()` to clear persisted data
   - Call `vi.restoreAllMocks()` to clean up any mock state

   **Mock sonner:** At top of file, mock the sonner module so toast calls don't throw:
   ```typescript
   vi.mock("sonner", () => ({
     toast: {
       warning: vi.fn(),
       error: vi.fn(),
       success: vi.fn(),
     },
   }));
   ```
   Import `toast` from `"sonner"` for assertion purposes.

   **Test suites to write:**

   a. `describe("setPlayers")`:
      - Accepts 2 players (minimum)
      - Accepts 6 players (maximum)
      - Rejects 1 player (below minimum) — config should not update
      - Rejects 7 players (above maximum) — config should not update
      - Shows toast.warning when rejecting invalid player count
      - Rejects empty array

   b. `describe("setNumberOfHoles")`:
      - Accepts 1 hole (minimum)
      - Accepts 36 holes (maximum)
      - Rejects 0 holes
      - Rejects 37 holes
      - Rejects non-integer (e.g., 9.5)

   c. `describe("setHandicap")`:
      - Accepts handicap within hole count range
      - Rejects handicap exceeding hole count
      - Shows toast.warning when rejecting
      - Rejects non-integer handicap value
      - First requires config to exist (set up players/holes before testing)

   d. `describe("submitHoleStrokes")`:
      - Rejects stroke value below 0 — verify toast.warning called
      - Rejects stroke value above 20 — verify toast.warning called
      - Rejects non-integer stroke value (e.g., 3.5) — verify toast.warning called
      - Rejects hole number below 1
      - Rejects hole number above config.numberOfHoles
      - Accepts valid strokes and persists results
      - Calls verifyZeroSum (verify via console.warn spy or by checking results are persisted)
      - Edge case: re-scoring an existing hole replaces the old data

   e. `describe("resetGame")`:
      - Clears all state back to initialState
      - Config becomes null after reset
      - holeStrokes becomes empty after reset

   f. `describe("hasActiveGame")`:
      - Returns false with no config
      - Returns false with config but no strokes
      - Returns true with config and at least one stroke entry

   g. `describe("state versioning")`:
      - Store persist config includes version field (verify via store internals or by checking localStorage shape after hydration)

   **Helper:** Create a helper function to set up a valid game state for tests that need it:
   ```typescript
   function setupGameWithPlayers(count: number = 2, holes: number = 18) {
     const players = Array.from({ length: count }, (_, i) => ({
       id: `player-${i}`,
       name: `Player ${i + 1}`,
     }));
     const store = useGameStore.getState();
     store.setPlayers(players);
     store.setNumberOfHoles(holes);
     store.initializeHandicaps();
     return players;
   }
   ```

2. **Run all tests:** `npx vitest run` — ALL tests must pass (scoring + pairs + store).

3. **Set up pre-commit hook:**
   ```bash
   npm install -D simple-git-hooks
   ```

   Add to `package.json` at the top level:
   ```json
   "simple-git-hooks": {
     "pre-commit": "npx vitest run --bail 1"
   }
   ```

   Activate the hook:
   ```bash
   npx simple-git-hooks
   ```

4. **Update CLAUDE.md** at the project root to document the test command:
   - Under `## Commands`, add `npm test` and `npm run test:watch`
   - Update "No test framework is configured" to reflect Vitest is now configured
  </action>
  <verify>
    `npx vitest run` passes with 0 failures across all three test files. Verify `.git/hooks/pre-commit` exists and contains `vitest`. Verify `package.json` has `"test": "vitest run"` and `"simple-git-hooks"` config. Total test count should be 60+ individual assertions.
  </verify>
  <done>
    Store integration tests cover validation rejection (invalid strokes, handicaps, player counts), state versioning, game lifecycle (setup, play, reset). Pre-commit hook runs `vitest run --bail 1` before every commit. All tests green.
  </done>
</task>

</tasks>

<verification>
1. `npx vitest run` — all tests pass, 0 failures
2. Test files exist: `src/lib/__tests__/scoring.test.ts`, `src/lib/__tests__/pairs.test.ts`, `src/lib/__tests__/game-store.test.ts`
3. `vitest.config.mts` exists at project root
4. `package.json` has `"test": "vitest run"` script
5. `package.json` has `"simple-git-hooks"` config
6. `.git/hooks/pre-commit` exists and references vitest
7. Tests cover edge cases: 6 players, 36 holes, all ties, max handicap, turbo on every hole
</verification>

<success_criteria>
- `npx vitest run` passes with all tests green
- scoring.test.ts covers: getHandicapAdjustment, calculatePairHoleResult, calculatePlayerHoleScores, verifyZeroSum, getRunningTotals, getFinalRankings
- pairs.test.ts covers: makePairKey, parsePairKey, generatePairs, getPlayerName, distributeHandicapHoles
- game-store.test.ts covers: setPlayers validation, setHandicap validation, submitHoleStrokes validation, resetGame, hasActiveGame
- Pre-commit hook blocks commits when tests fail
- Total test count >= 60 individual test cases
</success_criteria>

<output>
After completion, create `.planning/phases/01-store-hardening-and-test-foundation/01-02-SUMMARY.md`
</output>
