---
phase: 16-history-game-loading-editing
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/app/history/page.tsx
  - src/app/results/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can tap a past game in the history list and see its full results (scores, rankings, charts, storytelling, pair breakdowns)"
    - "User can edit stroke values for any hole and any player in the loaded past game"
    - "User can edit handicap values and manually toggle handicap hole assignments in the loaded past game"
    - "After editing, all scores, rankings, storytelling, and head-to-head recalculate correctly"
    - "Edits persist back to IndexedDB -- closing and reopening the game shows the updated values"
  artifacts:
    - path: "src/app/history/page.tsx"
      provides: "Clickable game cards that load history games into the store and navigate to /results"
      contains: "loadHistoryGame"
    - path: "src/app/results/page.tsx"
      provides: "History-aware results page with back-to-history navigation"
      contains: "historyId"
  key_links:
    - from: "src/app/history/page.tsx"
      to: "src/lib/game-store.ts"
      via: "calls loadHistoryGame then router.push(/results)"
      pattern: "loadHistoryGame.*router\\.push"
    - from: "src/app/results/page.tsx"
      to: "src/lib/game-store.ts"
      via: "reads historyId to determine history mode"
      pattern: "historyId"
    - from: "src/app/results/page.tsx"
      to: "src/hooks/use-save-game.ts"
      via: "useSaveGame persists edits back to IndexedDB"
      pattern: "useSaveGame"
---

<objective>
Wire the history list to load past games into the results view, and adapt the results page for history editing mode.

Purpose: Complete the user-facing flow -- tap a past game, see full results, edit anything, changes auto-save back to IndexedDB.

Output: Modified history/page.tsx with clickable game cards, modified results/page.tsx with history mode awareness.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-history-game-loading-editing/16-01-SUMMARY.md
@src/app/history/page.tsx
@src/app/results/page.tsx
@src/lib/game-store.ts
@src/hooks/use-save-game.ts
@src/lib/history-db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make history game cards clickable and load into store</name>
  <files>src/app/history/page.tsx</files>
  <action>
Modify the history page to make each game card tappable:

1. Import `useGameStore` from `@/lib/game-store` and destructure `loadHistoryGame` from it.

2. Create a `handleGameSelect` function that:
   - Takes a `game: HistoryRecord` parameter
   - Calls `loadHistoryGame(game)` to hydrate the Zustand store
   - Calls `router.push("/results")` to navigate to the results page

3. Wrap each game card `<div>` with an onClick handler:
   ```tsx
   <div
     key={game.id}
     className="glass-card p-4 hover:bg-muted/30 transition-colors cursor-pointer active:scale-[0.98]"
     onClick={() => handleGameSelect(game)}
   >
   ```
   Add `cursor-pointer` and `active:scale-[0.98]` to the existing className to give visual tap feedback.

4. Add a subtle chevron-right icon to each game card to indicate it's tappable. Import `ChevronRight` from lucide-react. Add it to the date row:
   ```tsx
   <ChevronRight className="h-4 w-4 text-muted-foreground/50 ml-auto shrink-0" />
   ```
   Place it at the far right of the card, perhaps in the date row or as a standalone element.

No other changes to the history page layout -- keep it clean and simple.
  </action>
  <verify>
Run `npm run build` -- no TypeScript errors. The history page should render with clickable game cards.
  </verify>
  <done>
Each game card in the history list is tappable. Tapping calls `loadHistoryGame(game)` and navigates to `/results`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Adapt results page for history editing mode</name>
  <files>src/app/results/page.tsx</files>
  <action>
Add history mode awareness to the results page:

1. Read `historyId` from the game store:
   ```tsx
   const { config, playerScores, pairResults, holeStrokes, submitHoleStrokes, resetGame, isComplete, historyId } = useGameStore();
   ```

2. Derive a boolean: `const isHistoryMode = historyId !== null && historyId !== undefined;`

3. **Header changes:**
   - When `isHistoryMode`, change the header title from "Final Results" to "Game Details".
   - Add a back button (ArrowLeft icon) at the left of the header that navigates to `/history` when in history mode. When NOT in history mode, don't show the back button (current behavior).
   ```tsx
   {isHistoryMode && (
     <button
       className="h-9 w-9 rounded-lg flex items-center justify-center text-muted-foreground hover:text-foreground hover:bg-muted/50 transition-colors mr-2"
       onClick={() => {
         resetGame(); // Clear the loaded history game from the store
         router.push("/history");
       }}
       aria-label="Back to history"
     >
       <ArrowLeft className="h-5 w-5" />
     </button>
   )}
   ```
   Import `ArrowLeft` from lucide-react.

4. **Footer/bottom actions changes:**
   When `isHistoryMode`:
   - Replace the entire bottom actions bar with a single "Back to History" button (centered, full width) that resets the game and goes to `/history`.
   - Do NOT show "Play Again" or "New Game" buttons -- those make no sense when viewing a history game.
   ```tsx
   {isHistoryMode ? (
     <div className="sticky bottom-0 p-4 pb-safe bg-background/90 backdrop-blur-xl border-t border-border">
       <button
         className="w-full h-14 rounded-xl text-lg font-bold bg-muted border border-border text-foreground hover:bg-muted/80 active:scale-[0.97] transition-all flex items-center justify-center gap-2"
         onClick={() => {
           resetGame();
           router.push("/history");
         }}
       >
         <ArrowLeft className="h-5 w-5" />
         Back to History
       </button>
     </div>
   ) : (
     /* existing bottom actions */
   )}
   ```

5. **Guard fix:** The existing useEffect redirects to "/" when `!config?.players?.length`. Since `loadHistoryGame` is synchronous and sets config before navigation, this guard should work fine. No change needed unless testing reveals a flash.

6. **Disable entrance animation in history mode:** The shouldAnimate state triggers confetti/animation on first mount. When viewing a history game, skip this. The existing effect has an empty deps array and runs once on mount. Read historyId directly from the store snapshot to avoid stale closure:
   ```tsx
   useEffect(() => {
     if (isComplete && !useGameStore.getState().historyId) {
       setShouldAnimate(true);
       const t = setTimeout(() => setShouldAnimate(false), 2000);
       return () => clearTimeout(t);
     }
   }, []);
   ```

7. Keep all existing functionality intact -- ScoreAuditDialog, HandicapEditDialog, ScoreTrendChart, StoryHighlights, PairBreakdown, ShareResultsCard, editable scorecard. These all read from the game store and will work automatically with history-loaded data.
  </action>
  <verify>
Run `npm run build` -- no TypeScript errors. Run `npm test` -- all tests pass.
  </verify>
  <done>
Results page shows "Game Details" header with back button when viewing a history game. Bottom bar shows "Back to History" instead of Play Again/New Game. Entrance animation is skipped. All editing functionality (strokes, handicaps, hole toggles) works through existing store-based components.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete history game loading and editing flow</name>
  <action>
Verify the complete history game loading and editing flow end-to-end:
1. History page game cards are tappable with visual feedback
2. Tapping loads the game into the Zustand store and navigates to results page
3. Results page shows full game details (rankings, charts, storytelling, pair breakdowns, scorecard)
4. User can edit strokes (tap scorecard cells) and handicaps (settings icon) including Phase 15 manual hole toggle
5. Edits recalculate all scores and auto-save back to IndexedDB
6. "Back to History" button returns to the history list
  </action>
  <verify>
    1. Run `npm run dev` and open http://localhost:3000
    2. Navigate to History page -- you should see past games
    3. Tap any game card -- it should open the results view showing "Game Details" header
    4. Verify all sections render: rankings, score trend chart, story highlights, pair breakdowns, scorecard
    5. Tap a stroke value in the scorecard -- edit it using the number stepper -- verify rankings update
    6. Tap the handicap settings icon -- change a handicap value -- verify scores recalculate
    7. In the handicap dialog, toggle handicap holes on/off -- verify they persist and scores recalculate
    8. Tap "Back to History" -- go back to the history list
    9. Tap the SAME game again -- verify the edits you made are still there (persisted to IndexedDB)
    10. (If no history games exist, play a quick 2-player 3-hole game first to create one)
  </verify>
  <done>All HIST requirements verified: tap to view (HIST-01), edit strokes (HIST-02), edit handicaps with hole toggles (HIST-03), recalculate and persist (HIST-04).</done>
</task>

</tasks>

<verification>
- History page cards are clickable with visual feedback
- Tapping a game loads it into the store and shows the results page
- Results page header shows "Game Details" with back arrow in history mode
- Results page footer shows "Back to History" in history mode
- All editing works: strokes, handicaps, handicap hole toggles
- Edits trigger recalculation (rankings, charts, storytelling update)
- Edits persist to IndexedDB (re-opening the game shows changes)
- Normal live game flow to /results is unaffected
</verification>

<success_criteria>
All five HIST requirements are met:
- HIST-01: Tap past game -> detail/results view with scores, rankings, charts, storytelling
- HIST-02: Edit strokes for any hole/player
- HIST-03: Edit handicap values and manual hole assignments (Phase 15 UI)
- HIST-04: Edits recalculate and persist back to IndexedDB
</success_criteria>

<output>
After completion, create `.planning/phases/16-history-game-loading-editing/16-02-SUMMARY.md`
</output>
