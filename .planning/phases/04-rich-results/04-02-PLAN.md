---
phase: 04-rich-results
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/globals.css
  - src/components/results/winner-podium.tsx
  - src/components/results/share-results-card.tsx
  - src/lib/share.ts
  - src/app/results/page.tsx
autonomous: true

must_haves:
  truths:
    - "Winner is revealed with a staggered animated podium (3rd appears, then 2nd, then 1st with celebration confetti)"
    - "User can share or download results as a styled PNG image card"
    - "For 2-player games, winner is shown with head-to-head summary instead of podium"
    - "Podium animation only plays on first visit after completing a round"
  artifacts:
    - path: "src/components/results/winner-podium.tsx"
      provides: "Animated podium component with staggered CSS reveals and confetti"
      contains: "WinnerPodium"
    - path: "src/components/results/share-results-card.tsx"
      provides: "Styled card component for image export with share button"
      contains: "ShareResultsCard"
    - path: "src/lib/share.ts"
      provides: "Capture DOM-to-PNG and share/download utility"
      contains: "captureAndShare"
  key_links:
    - from: "src/components/results/winner-podium.tsx"
      to: "canvas-confetti"
      via: "imports confetti for celebration effect"
      pattern: "import confetti from.*canvas-confetti"
    - from: "src/lib/share.ts"
      to: "html-to-image"
      via: "imports toPng for DOM capture"
      pattern: "import.*toPng.*from.*html-to-image"
    - from: "src/app/results/page.tsx"
      to: "src/components/results/winner-podium.tsx"
      via: "renders WinnerPodium replacing old winner celebration"
      pattern: "<WinnerPodium"
    - from: "src/app/results/page.tsx"
      to: "src/components/results/share-results-card.tsx"
      via: "renders ShareResultsCard at bottom of results"
      pattern: "<ShareResultsCard"
---

<objective>
Add the staggered animated winner podium with confetti celebration and the shareable results image card with Web Share API + PNG download fallback.

Purpose: RSLT-03 and RSLT-04 -- completing a round culminates in a dramatic winner reveal, and users can share their results via the device share sheet or save as an image.
Output: WinnerPodium component, ShareResultsCard component, share utility, podium CSS animations, integrated into results page.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-rich-results/04-RESEARCH.md
@.planning/phases/04-rich-results/04-01-SUMMARY.md
@src/app/results/page.tsx
@src/lib/scoring.ts
@src/lib/types.ts
@src/lib/game-store.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install deps, add podium CSS, build WinnerPodium and share utilities</name>
  <files>
    src/app/globals.css
    src/components/results/winner-podium.tsx
    src/lib/share.ts
  </files>
  <action>
**Step 1: Install new dependencies.**
```bash
npm install html-to-image canvas-confetti
npm install -D @types/canvas-confetti
```

**Step 2: Add podium animation keyframes to `src/app/globals.css`.**

Add these keyframes in the `/* ========== ANIMATIONS ========== */` section (after the existing animations):

```css
@keyframes podium-rise {
  0% { opacity: 0; transform: translateY(40px) scale(0.9); }
  60% { opacity: 1; transform: translateY(-8px) scale(1.02); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

.podium-enter {
  opacity: 0;
  animation: podium-rise 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}
.podium-3rd { animation-delay: 0.3s; }
.podium-2nd { animation-delay: 0.9s; }
.podium-1st { animation-delay: 1.5s; }

/* Skip animation on subsequent visits */
.podium-instant {
  opacity: 1;
  transform: translateY(0) scale(1);
}
```

**Step 3: Create `src/components/results/winner-podium.tsx`.**

A `"use client"` component that accepts:
- `rankings: { player: Player; totalScore: number; rank: number }[]` (from `getFinalRankings`)
- `shouldAnimate: boolean` (whether to play the staggered animation)

Implementation details:

**For 3+ player games (podium layout):**
- Show the top 3 players in a podium arrangement.
- Visual layout: three columns in a flex row, ordered as [2nd, 1st, 3rd] visually (1st in center, taller).
- Each podium position is a column containing:
  - Player name (font-bold, truncated)
  - Score (emerald if positive, rose if negative, slate if zero, with +/- prefix)
  - A colored podium bar below:
    - 1st: amber gradient background (`from-amber-400 to-orange-500`), tallest (h-24)
    - 2nd: slate-400 background, medium height (h-16)
    - 3rd: amber-700 background, shortest (h-10)
  - Rank number on the podium bar (large, bold, white)
- CSS classes: If `shouldAnimate` is true, apply `podium-enter podium-1st|2nd|3rd` classes. If false, apply `podium-instant`.
- Crown icon (`lucide-react Crown`) above 1st place player name.
- When `shouldAnimate` is true, fire `canvas-confetti` after 1st place animation completes (~2.1s delay):
  ```typescript
  import confetti from "canvas-confetti";
  useEffect(() => {
    if (!shouldAnimate) return;
    const timer = setTimeout(() => {
      confetti({ particleCount: 80, spread: 60, origin: { x: 0.3, y: 0.6 }, disableForReducedMotion: true });
      confetti({ particleCount: 80, spread: 60, origin: { x: 0.7, y: 0.6 }, disableForReducedMotion: true });
    }, 2100);
    return () => clearTimeout(timer);
  }, [shouldAnimate]);
  ```
- If there are players ranked 4th and below, show them in a simple ranked list below the podium (similar to the existing rankings card style but compact -- just rank number, name, and score on one line).

**For exactly 2 players (no podium):**
- Show the winner prominently: large name, score, Crown icon, and "Champion" label (similar to the current winner celebration style).
- Show the runner-up below in smaller text with their score.
- If `shouldAnimate` is true, apply `podium-enter podium-1st` to the winner section and fire confetti.
- No podium bars needed -- just a clean winner + runner-up display.

**For 1 player (edge case):** Just show the player name and score, no animation.

**Step 4: Create `src/lib/share.ts`.**

Export an async function `captureAndShare(element: HTMLElement, filename?: string): Promise<void>`.

Implementation:
```typescript
import { toPng } from "html-to-image";
import { toast } from "sonner";

export async function captureAndShare(
  element: HTMLElement,
  filename: string = "golf-results.png"
): Promise<void> {
  try {
    // Capture DOM node as PNG data URL
    const dataUrl = await toPng(element, {
      cacheBust: true,
      pixelRatio: 2,
      backgroundColor: "#0f172a", // slate-950
    });

    // Convert to File
    const blob = await (await fetch(dataUrl)).blob();
    const file = new File([blob], filename, { type: "image/png" });

    // Try Web Share API
    if (
      typeof navigator !== "undefined" &&
      navigator.canShare &&
      navigator.canShare({ files: [file] })
    ) {
      try {
        await navigator.share({ files: [file], title: "Golf Results" });
        return;
      } catch (err) {
        if ((err as Error).name === "AbortError") return; // User cancelled
        // Fall through to download
      }
    }

    // Fallback: download
    const link = document.createElement("a");
    link.download = filename;
    link.href = dataUrl;
    link.click();
    toast.success("Results saved!");
  } catch (err) {
    console.error("Share failed:", err);
    toast.error("Failed to capture results image");
  }
}
```

Also export a helper `canNativeShare(): boolean` that returns true if Web Share API with file support is available. The results page will use this to determine button label ("Share" vs "Save Image").
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Verify `canvas-confetti` and `html-to-image` are in `package.json` dependencies. Verify `@types/canvas-confetti` is in devDependencies. Verify `src/app/globals.css` contains the `podium-rise` keyframe.
  </verify>
  <done>
WinnerPodium component renders a staggered animated podium (3 players) or winner spotlight (2 players) with confetti on first visit. Share utility can capture a DOM element as PNG and share via Web Share API or download as fallback. Podium CSS animations are defined in globals.css.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build ShareResultsCard and integrate podium + share into results page</name>
  <files>
    src/components/results/share-results-card.tsx
    src/app/results/page.tsx
  </files>
  <action>
**Step 1: Create `src/components/results/share-results-card.tsx`.**

A `"use client"` component that accepts:
- `rankings: { player: Player; totalScore: number; rank: number }[]`
- `numberOfHoles: number`

Implementation details:
- Uses `useRef<HTMLDivElement>` for the capturable card element.
- Uses `useState<boolean>(false)` for loading state during capture.
- Imports `captureAndShare`, `canNativeShare` from `@/lib/share`.
- Imports `Share2`, `Download` from `lucide-react`.

**The share card (capturable area):**
- A fixed-width div (w-[375px]) with explicit hex colors for reliable capture (NOT oklch CSS variables):
  - Background: `bg-[#0f172a]` (slate-950)
  - Text: `text-[#f8fafc]` (slate-50)
  - Muted text: `text-[#94a3b8]` (slate-400)
  - Emerald: `text-[#34d399]`
  - Rose: `text-[#fb7185]`
- Content:
  - App branding: "Golf Handicap Scorer" heading + "{numberOfHoles} holes" subtext
  - Winner spotlight: Large name + score with crown emoji (Unicode, not icon component for reliable capture)
  - Rankings list: Each player with rank number, name, and score (emerald/rose coloring)
  - Footer: subtle "golfscorer.app" or similar branding text in small muted text
- This card is rendered off-screen: `position: fixed; left: -9999px; top: 0;` so it is laid out by the browser but not visible. Do NOT use `display: none`.

**The share button (visible):**
- Rendered inline in the results page flow, inside a glass-card.
- Button label: If `canNativeShare()` returns true, show `<Share2 /> Share Results`. Otherwise show `<Download /> Save Results`.
- On click: set loading true, call `captureAndShare(cardRef.current)`, set loading false.
- While loading, show a spinner or "Capturing..." text and disable the button.

Export the component as `ShareResultsCard`.

**Step 2: Integrate into `src/app/results/page.tsx`.**

Replace the current winner celebration section with the WinnerPodium component:

1. Add imports:
   ```typescript
   import { WinnerPodium } from "@/components/results/winner-podium";
   import { ShareResultsCard } from "@/components/results/share-results-card";
   ```

2. Track whether podium animation should play. Use a `useRef<boolean>(false)` called `hasAnimatedRef`. On first render, if `isComplete` is true (game was just completed), set `shouldAnimate = !hasAnimatedRef.current` and then set `hasAnimatedRef.current = true`. This ensures animation plays only once per component mount after game completion.

   Note: Since the store persists `isComplete: true`, the ref resets on page refresh/remount. This is acceptable -- the animation replays if the user fully refreshes the page, but NOT if they navigate away and back within the same session. This matches the research recommendation.

3. Replace the entire "Winner celebration" section (`{rankings.length > 0 && (...)}` block, lines ~86-113 of the current page) with:
   ```tsx
   {rankings.length > 0 && (
     <WinnerPodium
       rankings={rankings}
       shouldAnimate={shouldAnimate}
     />
   )}
   ```

4. Add the ShareResultsCard after the Scorecard section and before the bottom action bar:
   ```tsx
   <ShareResultsCard
     rankings={rankings}
     numberOfHoles={config.numberOfHoles}
   />
   ```

5. Import `isComplete` from the store (add to existing destructure).

6. Final page layout order:
   1. Header (existing)
   2. WinnerPodium (REPLACED old winner celebration)
   3. Rankings card (existing from 04-01)
   4. Score Trend Chart (from 04-01)
   5. Head-to-Head Pair Breakdowns (from 04-01)
   6. Editable Scorecard (existing)
   7. ShareResultsCard with share/download button (NEW)
   8. Bottom action bar (existing -- Home + New Game)
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors. Run `npm test` to confirm existing tests pass. Start dev server with an active completed game (set `isComplete: true` in store). Verify:
1. Podium animates on first load (3rd, 2nd, 1st staggered) with confetti
2. Navigating away and back does NOT replay animation within same session
3. Share/Save button captures a PNG image card
4. For 2-player games, winner spotlight shows instead of podium
  </verify>
  <done>
Results page has an animated winner podium with confetti (or winner spotlight for 2 players) and a share/save button that captures a styled results card as PNG. Podium animation only plays on first visit. Share uses Web Share API when available, falls back to PNG download.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes without errors
2. `npm test` passes (all existing tests)
3. For 3+ player games: podium shows 3rd, then 2nd, then 1st with staggered CSS animation, confetti fires after 1st place reveals
4. For 2 player games: winner spotlight with confetti, no podium layout
5. Podium animation does NOT replay when navigating away and returning within same session
6. Share button label adapts: "Share Results" on devices with Web Share API, "Save Results" on desktop
7. Clicking share/save produces a well-styled PNG image card with rankings (using hex colors, not oklch)
8. The PNG download fallback works on all browsers (tested in Firefox desktop)
</verification>

<success_criteria>
- Winner podium animates in staggered order (3rd -> 2nd -> 1st) with confetti on first visit
- 2-player games show winner spotlight instead of podium
- Share button exports a styled image card as PNG via Web Share API or download fallback
- Share card uses explicit hex colors for reliable html-to-image capture
- All existing results page functionality preserved (rankings, chart, pair breakdowns, scorecard, navigation)
- Build passes, tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-rich-results/04-02-SUMMARY.md`
</output>
