---
phase: 07-theme-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - src/lib/game-store.ts
  - src/lib/types.ts
  - src/components/shared/undo-banner.tsx
  - src/app/play/page.tsx
autonomous: true

must_haves:
  truths:
    - "After submitting a hole's scores, an undo button appears for 10 seconds"
    - "Tapping undo reverts the last submission and navigates back to the undone hole"
    - "Undo button disappears after 10 seconds"
    - "Undo snapshot is NOT persisted to localStorage"
  artifacts:
    - path: "src/lib/game-store.ts"
      provides: "undoLastSubmission action and snapshot state"
      exports: ["useGameStore"]
    - path: "src/components/shared/undo-banner.tsx"
      provides: "Floating undo button with countdown timer"
      exports: ["UndoBanner"]
  key_links:
    - from: "src/app/play/page.tsx"
      to: "src/lib/game-store.ts"
      via: "submitHoleStrokes snapshots state, undoLastSubmission restores it"
      pattern: "undoLastSubmission"
    - from: "src/app/play/page.tsx"
      to: "src/components/shared/undo-banner.tsx"
      via: "UndoBanner rendered when _undoSnapshot exists"
      pattern: "UndoBanner"
    - from: "src/lib/game-store.ts"
      to: "zustand persist"
      via: "partialize excludes _undoSnapshot from localStorage"
      pattern: "partialize"
---

<objective>
Add undo capability for the last score submission with a 10-second timeout (THEM-02).

Purpose: On the golf course, mistakes happen -- wrong stroke count, wrong hole, accidental submit. A 10-second undo window provides a safety net without disrupting the scoring flow. The undo button persists even after auto-advancing to the next hole.

Output: Store-level undo snapshot/restore, floating UndoBanner component with countdown, integrated on the play page.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-theme-and-polish/07-RESEARCH.md
@src/lib/game-store.ts
@src/app/play/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add undo snapshot/restore to Zustand game store</name>
  <files>
    src/lib/game-store.ts
    src/lib/types.ts
  </files>
  <action>
1. **Add undo fields to GameStore interface** in `game-store.ts`:
   ```ts
   _undoSnapshot: Pick<GameState, "holeStrokes" | "pairResults" | "playerScores" | "currentHole"> | null;
   undoLastSubmission: () => void;
   clearUndoSnapshot: () => void;
   ```
   Do NOT add `_undoSnapshot` to the `GameState` interface in `types.ts` -- it's store-only, not domain state.

2. **Add `_undoSnapshot: null` to `initialState`** in `game-store.ts` (add it after `isComplete: false`). This is technically outside GameState's type, so cast or use intersection: the store interface already extends GameState with extra fields, so just add it to the object literal.

3. **Modify `submitHoleStrokes` action** to snapshot BEFORE mutating:
   - At the top of the `set()` callback (before any calculation), capture:
     ```ts
     const snapshot = {
       holeStrokes: state.holeStrokes,
       pairResults: state.pairResults,
       playerScores: state.playerScores,
       currentHole: state.currentHole,
     };
     ```
   - Include `_undoSnapshot: snapshot` in the return object (alongside the existing `holeStrokes`, `pairResults`, `playerScores`).
   - The snapshot captures immutable references (Zustand state is replaced, not mutated), so this is safe.

4. **Add `undoLastSubmission` action:**
   ```ts
   undoLastSubmission: () =>
     set((state) => {
       if (!state._undoSnapshot) return {};
       return {
         holeStrokes: state._undoSnapshot.holeStrokes,
         pairResults: state._undoSnapshot.pairResults,
         playerScores: state._undoSnapshot.playerScores,
         currentHole: state._undoSnapshot.currentHole,
         _undoSnapshot: null,
       };
     }),
   ```

5. **Add `clearUndoSnapshot` action:**
   ```ts
   clearUndoSnapshot: () => set({ _undoSnapshot: null }),
   ```

6. **Add `partialize` to persist config** to exclude `_undoSnapshot` from localStorage:
   The persist config currently only has `name`, `version`, `migrate`, `onRehydrateStorage`. Add:
   ```ts
   partialize: (state) => {
     const { _undoSnapshot, ...rest } = state;
     return rest;
   },
   ```
   Place it after the `name` field. Note: `partialize` receives the full store state (including actions), but Zustand's persist middleware handles this correctly -- it only serializes data fields.

7. **Update `resetGame`** to also clear the undo snapshot:
   ```ts
   resetGame: () => set({ ...initialState, _undoSnapshot: null }),
   ```
  </action>
  <verify>
    Run `npm test` -- all existing tests pass (snapshot logic doesn't break scoring). Run `npm run build` -- no TypeScript errors. Inspect the persist config has `partialize` that excludes `_undoSnapshot`.
  </verify>
  <done>
    `submitHoleStrokes` captures a snapshot before mutating state. `undoLastSubmission` restores the snapshot and clears it. `clearUndoSnapshot` provides explicit cleanup. `partialize` excludes `_undoSnapshot` from localStorage persistence. All existing tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UndoBanner component and integrate on play page</name>
  <files>
    src/components/shared/undo-banner.tsx
    src/app/play/page.tsx
  </files>
  <action>
1. **Create `src/components/shared/undo-banner.tsx`:**
   - `"use client"` component
   - Props: `onUndo: () => void`, `durationMs?: number` (default 10000)
   - State: `remaining` (countdown in ms), starts at `durationMs`
   - useEffect with `setInterval(100ms)` that decrements `remaining` by 100 each tick. Clean up interval on unmount.
   - When `remaining <= 0`, return `null` (auto-dismiss).
   - Render a fixed-position floating button:
     ```tsx
     <button
       onClick={onUndo}
       className="fixed bottom-24 left-1/2 -translate-x-1/2 z-40 flex items-center gap-2 px-5 py-3 rounded-full bg-destructive text-destructive-foreground text-sm font-bold shadow-lg shadow-destructive/25 active:scale-95 transition-transform"
     >
       <Undo2 className="h-4 w-4" />
       Undo ({Math.ceil(remaining / 1000)}s)
     </button>
     ```
   - Import `Undo2` from `lucide-react`.
   - Position at `bottom-24` to clear the play page's bottom action bar (which is `h-14` + `p-4` + safe area).
   - Add a subtle progress bar or opacity fade as time runs out (optional polish): reduce opacity to 0.7 in the last 3 seconds.

2. **Integrate UndoBanner on play page (`src/app/play/page.tsx`):**
   - Import `UndoBanner` from `@/components/shared/undo-banner`.
   - Add `undoLastSubmission`, `clearUndoSnapshot` to the destructured `useGameStore()` call.
   - Add `_undoSnapshot` to the destructured store (use selector or just destructure).
   - Track undo state with a local `showUndo` state + `undoKey`:
     ```tsx
     const [undoKey, setUndoKey] = useState(0);
     ```
   - In `handleSubmitAndAdvance`:
     - After `submitHoleStrokes(holeData)`, increment undoKey: `setUndoKey(k => k + 1)` to reset the UndoBanner timer.
   - In `handleSubmitLastHole`:
     - Same: increment undoKey after submission.
   - Create `handleUndo` callback:
     ```tsx
     const handleUndo = useCallback(() => {
       undoLastSubmission();
       vibrate(30);
     }, [undoLastSubmission]);
     ```
     The `undoLastSubmission` action restores `currentHole` to the pre-submit value, so the UI automatically navigates back.
   - Render `UndoBanner` conditionally when `_undoSnapshot` is not null:
     ```tsx
     {_undoSnapshot && (
       <UndoBanner key={undoKey} onUndo={handleUndo} durationMs={10000} />
     )}
     ```
     The `key={undoKey}` ensures a fresh timer on each new submission.
   - When UndoBanner's timer expires (component unmounts via `remaining <= 0` returning null), the `_undoSnapshot` remains in the store but is harmless (excluded from persist). For cleanliness, add an `onExpire` callback prop to UndoBanner that calls `clearUndoSnapshot()`:
     ```tsx
     // In UndoBanner: call onExpire when remaining hits 0
     useEffect(() => {
       if (remaining <= 0 && onExpire) onExpire();
     }, [remaining, onExpire]);
     ```
     ```tsx
     // In play page:
     <UndoBanner key={undoKey} onUndo={handleUndo} onExpire={clearUndoSnapshot} durationMs={10000} />
     ```
  </action>
  <verify>
    Run `npm run build` -- no errors. Run `npm test` -- all tests pass. Manual verification flow: submit a hole's scores on the play page, confirm the undo button appears at the bottom. Tap undo -- scores revert and hole navigates back. Wait 10 seconds -- undo button disappears.
  </verify>
  <done>
    After submitting a hole's scores, a floating "Undo (Xs)" button appears at the bottom of the play page for 10 seconds. Tapping it restores the pre-submission state (scores, pair results, player scores, current hole). The button auto-dismisses after 10 seconds. Undo snapshot is never persisted to localStorage.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` -- zero errors
2. Run `npm test` -- all existing tests pass
3. Verify `partialize` in store: `grep "partialize" src/lib/game-store.ts` returns match
4. Verify UndoBanner import on play page: `grep "UndoBanner" src/app/play/page.tsx` returns match
5. Verify undoLastSubmission action: `grep "undoLastSubmission" src/lib/game-store.ts` returns match
</verification>

<success_criteria>
- After submitting scores for any hole, a floating undo button appears for 10 seconds
- Tapping undo reverts all state (holeStrokes, pairResults, playerScores, currentHole)
- After undo, the play page shows the hole that was just undone with original stroke values
- Undo button disappears after 10 seconds with no stale state
- Undo snapshot is excluded from localStorage persistence
- Existing game flow (submit, auto-advance, confirmation flash) is unchanged
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-theme-and-polish/07-02-SUMMARY.md`
</output>
