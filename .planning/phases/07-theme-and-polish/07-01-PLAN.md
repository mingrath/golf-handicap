---
phase: 07-theme-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/globals.css
  - src/app/layout.tsx
  - src/components/ui/sonner.tsx
  - src/components/shared/theme-toggle.tsx
  - src/app/page.tsx
  - src/app/play/page.tsx
  - src/app/setup/page.tsx
  - src/app/results/page.tsx
  - src/app/history/page.tsx
  - src/app/stats/page.tsx
  - src/components/shared/game-header.tsx
  - src/components/shared/stroke-input.tsx
  - src/components/shared/number-stepper.tsx
  - src/components/shared/mini-leaderboard.tsx
  - src/components/shared/hydration-gate.tsx
  - src/components/results/winner-podium.tsx
  - src/components/results/pair-breakdown.tsx
  - src/components/results/share-results-card.tsx
  - src/components/results/score-trend-chart.tsx
  - src/components/stats/player-stat-card.tsx
  - src/components/stats/win-rate-chart.tsx
autonomous: true

must_haves:
  truths:
    - "App matches device dark/light system preference on first load"
    - "User can manually toggle between light and dark themes"
    - "Theme choice persists across page reloads"
    - "All pages render correctly in both light and dark themes"
    - "Share card remains dark-themed regardless of app theme"
  artifacts:
    - path: "src/app/globals.css"
      provides: "Light and dark CSS variable palettes"
      contains: ".dark"
    - path: "src/components/shared/theme-toggle.tsx"
      provides: "Theme toggle button component"
      exports: ["ThemeToggle"]
    - path: "src/app/layout.tsx"
      provides: "ThemeProvider wrapper with system detection"
      contains: "ThemeProvider"
  key_links:
    - from: "src/app/layout.tsx"
      to: "next-themes"
      via: "ThemeProvider with attribute='class'"
      pattern: "ThemeProvider.*attribute.*class"
    - from: "src/components/shared/theme-toggle.tsx"
      to: "next-themes"
      via: "useTheme hook"
      pattern: "useTheme"
    - from: "src/app/globals.css"
      to: "tailwindcss"
      via: "@custom-variant dark with :where selector"
      pattern: "@custom-variant dark.*:where"
---

<objective>
Add dark/light theme support with automatic system preference detection and manual toggle (THEM-01).

Purpose: The app is used outdoors on a golf course. Dark mode works at dusk/night but light mode with high contrast is better under direct sunlight. System auto-detection ensures the right theme loads without manual intervention.

Output: Working theme system with light/dark CSS palettes, ThemeProvider integration, theme toggle UI on home page, and all ~215 hardcoded color references migrated to semantic tokens.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-theme-and-polish/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Theme infrastructure -- CSS palettes, ThemeProvider, toggle, sonner, viewport</name>
  <files>
    src/app/globals.css
    src/app/layout.tsx
    src/components/ui/sonner.tsx
    src/components/shared/theme-toggle.tsx
  </files>
  <action>
1. **Fix @custom-variant in globals.css** (line 5):
   Change `@custom-variant dark (&:is(.dark *));` to `@custom-variant dark (&:where(.dark, .dark *));`

2. **Split CSS variables into light/dark palettes in globals.css:**
   - Current `:root` block has dark palette values. Move them into a `.dark { }` block.
   - Create new `:root` block with light palette (shadcn neutral with emerald primary):
     ```
     :root {
       --radius: 0.75rem;
       --background: oklch(1 0 0);
       --foreground: oklch(0.145 0.015 260);
       --card: oklch(1 0 0);
       --card-foreground: oklch(0.145 0.015 260);
       --popover: oklch(1 0 0);
       --popover-foreground: oklch(0.145 0.015 260);
       --primary: oklch(0.55 0.19 163);
       --primary-foreground: oklch(0.98 0 0);
       --secondary: oklch(0.96 0.005 260);
       --secondary-foreground: oklch(0.24 0.015 260);
       --muted: oklch(0.96 0.005 260);
       --muted-foreground: oklch(0.45 0.01 260);
       --accent: oklch(0.96 0.005 260);
       --accent-foreground: oklch(0.24 0.015 260);
       --destructive: oklch(0.55 0.22 25);
       --border: oklch(0.9 0.005 260);
       --input: oklch(0.9 0.005 260);
       --ring: oklch(0.55 0.19 163);
       --chart-1: oklch(0.55 0.19 163);
       --chart-2: oklch(0.6 0.15 85);
       --chart-3: oklch(0.55 0.22 25);
       --chart-4: oklch(0.55 0.15 250);
       --chart-5: oklch(0.55 0.18 320);
     }
     ```
   - `.dark` block gets the EXISTING `:root` values (the current dark palette) including sidebar vars.
   - Keep `--radius: 0.75rem;` in both blocks (or just `:root`).

3. **Theme custom CSS utilities in globals.css:**
   - `.glass-card`: Change hardcoded `rgba(30, 41, 59, 0.7)` to use CSS variables or add light override:
     ```css
     .glass-card {
       background: oklch(from var(--card) l c h / 0.7);
       backdrop-filter: blur(16px);
       -webkit-backdrop-filter: blur(16px);
       border: 1px solid oklch(from var(--border) l c h / 0.15);
       border-radius: 1rem;
     }
     ```
     If `oklch(from ...)` is not well-supported, use the two-block approach:
     ```css
     .glass-card { background: rgba(255, 255, 255, 0.8); border: 1px solid rgba(0,0,0,0.08); ... }
     .dark .glass-card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(148, 163, 184, 0.15); ... }
     ```
   - `.score-positive`, `.score-negative`, `.score-neutral`: Keep as-is (emerald/rose colors are theme-agnostic -- they work on both light and dark backgrounds).
   - `.text-gradient`: Keep as-is (emerald/teal/cyan gradient is brand-consistent on both themes).

4. **Wrap app in ThemeProvider in layout.tsx:**
   - Add `import { ThemeProvider } from "next-themes";`
   - Add `suppressHydrationWarning` to `<html>` tag
   - Wrap `<HydrationGate>{children}</HydrationGate>` and `<Toaster>` inside `<ThemeProvider attribute="class" defaultTheme="system" enableSystem disableTransitionOnChange>`
   - ThemeProvider must be INSIDE `<body>` (it's a client component)

5. **Update viewport themeColor in layout.tsx** for responsive browser chrome:
   ```ts
   themeColor: [
     { media: "(prefers-color-scheme: dark)", color: "#0f172a" },
     { media: "(prefers-color-scheme: light)", color: "#ffffff" },
   ],
   ```

6. **Update Sonner Toaster (src/components/ui/sonner.tsx):**
   - Add `import { useTheme } from "next-themes";`
   - Replace hardcoded `theme="dark"` with `theme={(resolvedTheme as "dark" | "light") ?? "dark"}`
   - Remove the hardcoded style overrides (`--normal-bg`, `--normal-text`, `--normal-border`) since sonner handles theming natively

7. **Create ThemeToggle component (src/components/shared/theme-toggle.tsx):**
   - `"use client"` component
   - Import `useTheme` from `next-themes`, `Sun` and `Moon` from `lucide-react`, `useState` and `useEffect` from react
   - Use mounted guard: `const [mounted, setMounted] = useState(false); useEffect(() => setMounted(true), []);`
   - Return `null` if not mounted
   - Cycle through themes: light -> dark -> system -> light (or simpler: toggle between light/dark)
   - Render a compact button with Sun icon in dark mode, Moon icon in light mode
   - Style: `rounded-full p-2 bg-muted text-muted-foreground hover:bg-accent transition-colors`
  </action>
  <verify>
    Run `npm run build` -- no TypeScript or build errors. Inspect `globals.css` has both `:root` (light) and `.dark` (dark) blocks. Verify `@custom-variant` uses `:where()` not `:is()`.
  </verify>
  <done>
    ThemeProvider wraps app in layout.tsx with attribute="class" and defaultTheme="system". Light and dark CSS variable palettes defined in globals.css. ThemeToggle component exists with mounted guard. Sonner Toaster uses resolved theme. Viewport themeColor responds to prefers-color-scheme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate hardcoded colors to semantic tokens across all pages and components</name>
  <files>
    src/app/page.tsx
    src/app/play/page.tsx
    src/app/setup/page.tsx
    src/app/results/page.tsx
    src/app/history/page.tsx
    src/app/stats/page.tsx
    src/components/shared/game-header.tsx
    src/components/shared/stroke-input.tsx
    src/components/shared/number-stepper.tsx
    src/components/shared/mini-leaderboard.tsx
    src/components/shared/hydration-gate.tsx
    src/components/results/winner-podium.tsx
    src/components/results/pair-breakdown.tsx
    src/components/results/share-results-card.tsx
    src/components/results/score-trend-chart.tsx
    src/components/stats/player-stat-card.tsx
    src/components/stats/win-rate-chart.tsx
  </files>
  <action>
Apply the following color mapping systematically to ALL files listed above. Read each file, find hardcoded slate/white colors, replace with semantic equivalents:

**Color mapping (find -> replace):**
| Find | Replace With |
|------|-------------|
| `bg-slate-950` | `bg-background` |
| `text-white` | `text-foreground` |
| `bg-slate-800/80` | `bg-muted` |
| `bg-slate-800/50` | `bg-muted/50` |
| `bg-slate-800/40` | `bg-muted/40` |
| `bg-slate-800` | `bg-muted` |
| `bg-slate-900/90` | `bg-card/90` |
| `bg-slate-900/50` | `bg-card/50` |
| `text-slate-200` | `text-foreground` |
| `text-slate-300` | `text-muted-foreground` |
| `text-slate-400` | `text-muted-foreground` |
| `text-slate-500` | `text-muted-foreground` |
| `text-slate-600` | `text-muted-foreground` |
| `border-slate-700/50` | `border-border` |
| `border-slate-700/30` | `border-border/50` |
| `border-slate-800/50` | `border-border` |
| `border-slate-600/50` | `border-border` |
| `bg-slate-700/80` | `bg-muted` |
| `bg-slate-700/50` | `bg-muted/50` |
| `bg-slate-700` | `bg-muted` |
| `bg-slate-950/90` | `bg-background/90` |
| `hover:bg-slate-700/80` | `hover:bg-muted/80` |
| `hover:bg-slate-700/50` | `hover:bg-muted/50` |
| `hover:bg-slate-700` | `hover:bg-muted` |
| `hover:bg-slate-800/50` | `hover:bg-muted/50` |
| `hover:text-white` | `hover:text-foreground` |
| `hover:text-slate-200` | `hover:text-foreground` |
| `bg-white/5` | `bg-foreground/5` |

**Preserve these (do NOT change):**
- Emerald/teal/cyan/rose/amber colors (score indicators, gradients, turbo badges) -- theme-agnostic accents
- All inline `style={{ }}` in `share-results-card.tsx` -- per decision [04-02], the capture card must stay hardcoded dark
- The share button in `share-results-card.tsx` that has `bg-slate-800` -- change this one since it's interactive UI (not the captured image)
- Chart inline rgba values in `score-trend-chart.tsx` -- change tick/grid colors to use CSS var or `text-muted-foreground` equivalent

**Special cases:**
- **Home page (`page.tsx`)**: The ambient background glow divs (`bg-emerald-600/10`, `bg-teal-500/8`, `bg-cyan-500/5`) are fine on both themes. The grid pattern overlay uses `rgba(255,255,255,0.3)` inline -- change to `rgba(0,0,0,0.15)` for light mode by using `opacity-[0.03] dark:opacity-[0.03]` with theme-appropriate base. Or leave as-is if the subtle effect is acceptable on both backgrounds.
- **Home page**: Add `<ThemeToggle />` to the top-right corner. Import from `@/components/shared/theme-toggle`. Position with `absolute top-4 right-4 z-20`.
- **Play page**: The confirmation flash uses `bg-emerald-500/20 backdrop-blur-sm` with `text-emerald-400` -- keep as-is, works on both themes.
- **Play page**: Hole navigator unscored buttons use `bg-slate-800/80 text-slate-500` -- replace with `bg-muted text-muted-foreground`.
- **Hydration gate**: Loading skeleton uses `bg-slate-950` background and `bg-slate-800/50` spinner -- replace with semantic tokens.
  </action>
  <verify>
    Run `npm run build` -- no errors. Run `grep -rn "bg-slate-\|text-slate-\|border-slate-" src/app/ src/components/shared/ src/components/results/ src/components/stats/` and confirm zero matches except intentionally preserved cases (share-results-card.tsx inline styles). Verify `text-white` occurrences are gone except in gradient buttons (which pair with specific bg colors and need white text regardless of theme).
  </verify>
  <done>
    All ~215 hardcoded slate/white color references across 17 files are replaced with semantic tokens (bg-background, text-foreground, bg-card, bg-muted, text-muted-foreground, border-border). ThemeToggle rendered on home page. Light and dark modes render correctly across all pages. Share card remains dark-only per decision [04-02].
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build` -- zero errors
2. Run `npm test` -- all existing tests pass (color changes don't affect logic)
3. Grep for remaining hardcoded slate colors: `grep -rn "bg-slate-\|text-slate-\|border-slate-" src/` should return only share-results-card.tsx (if any remain for the captured image)
4. Grep for broken custom-variant: `grep "@custom-variant" src/app/globals.css` should show `:where(.dark, .dark *)`
5. Verify ThemeProvider in layout: `grep "ThemeProvider" src/app/layout.tsx` returns match
</verification>

<success_criteria>
- App auto-detects system dark/light preference on first load
- User can toggle between light and dark via button on home page
- Theme persists across page navigation and browser reloads
- All pages (home, setup, play, results, history, stats) render correctly in both themes
- Share card image remains dark-themed regardless of app theme
- Sonner toasts match current theme
- Browser chrome (theme-color) adapts to system preference
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-theme-and-polish/07-01-SUMMARY.md`
</output>
