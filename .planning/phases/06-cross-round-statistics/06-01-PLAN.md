---
phase: 06-cross-round-statistics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/stats.ts
  - src/hooks/use-player-stats.ts
  - src/components/stats/player-stat-card.tsx
  - src/components/stats/win-rate-chart.tsx
  - src/app/stats/page.tsx
  - src/app/page.tsx
  - src/app/history/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view per-player win rate across all saved rounds on /stats page"
    - "User can see average score, best round, and worst round for each player"
    - "Stats update automatically when a new round is completed and saved (useLiveQuery reactivity)"
    - "User can navigate to /stats from the home page and from the history page"
  artifacts:
    - path: "src/lib/stats.ts"
      provides: "Pure stats computation functions"
      exports: ["computeAllPlayerStats", "computePlayerStats", "getUniquePlayerNames", "normalizePlayerName"]
      contains: "PlayerStats"
    - path: "src/hooks/use-player-stats.ts"
      provides: "Reactive hook wrapping useLiveQuery + stats computation"
      exports: ["usePlayerStats"]
    - path: "src/app/stats/page.tsx"
      provides: "Stats dashboard page"
      min_lines: 40
    - path: "src/components/stats/player-stat-card.tsx"
      provides: "Per-player stat summary card"
      exports: ["PlayerStatCard"]
    - path: "src/components/stats/win-rate-chart.tsx"
      provides: "Bar chart showing win rates per player"
      exports: ["WinRateChart"]
  key_links:
    - from: "src/hooks/use-player-stats.ts"
      to: "src/lib/history-db.ts"
      via: "useLiveQuery reading historyDb.games"
      pattern: "historyDb\\.games"
    - from: "src/hooks/use-player-stats.ts"
      to: "src/lib/stats.ts"
      via: "computeAllPlayerStats called inside useLiveQuery"
      pattern: "computeAllPlayerStats"
    - from: "src/app/stats/page.tsx"
      to: "src/hooks/use-player-stats.ts"
      via: "usePlayerStats hook"
      pattern: "usePlayerStats"
    - from: "src/app/page.tsx"
      to: "/stats"
      via: "View Stats navigation link"
      pattern: "router\\.push.*stats"
---

<objective>
Build a cross-round statistics dashboard at /stats that shows per-player win rates, average scores, best/worst rounds, and a win rate bar chart -- all computed reactively from the Dexie game history.

Purpose: Fulfills HIST-03 -- users can track performance over time across saved rounds, completing the game history feature set.
Output: Stats computation module, reactive hook, stat cards, win rate chart, /stats page, and navigation links from home and history pages.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cross-round-statistics/06-RESEARCH.md
@src/lib/history-db.ts
@src/hooks/use-player-stats.ts
@src/components/results/score-trend-chart.tsx
@src/app/page.tsx
@src/app/history/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create stats computation module and reactive hook</name>
  <files>src/lib/stats.ts, src/hooks/use-player-stats.ts</files>
  <action>
Create `src/lib/stats.ts` with pure functions for cross-round statistics:

1. `normalizePlayerName(name: string): string` -- trims and lowercases for case-insensitive matching across games.

2. `getUniquePlayerNames(games: HistoryRecord[]): string[]` -- collects unique player names across all games using a `Map<normalizedName, displayName>` (first occurrence kept as display name).

3. `computePlayerStats(playerName: string, games: HistoryRecord[]): PlayerStats` -- for a given player name, filters games containing that player (via `rankings[].playerName` normalized match), then computes:
   - `gamesPlayed`: count of matching games
   - `wins`: count where `ranking.rank === 1` (ties at rank 1 count as wins for all tied players)
   - `winRate`: `wins / gamesPlayed` (guard: 0 when gamesPlayed is 0)
   - `avgScore`: `sum(totalScore) / gamesPlayed` (guard: 0 when gamesPlayed is 0)
   - `bestRound`: `{ score, date }` with highest totalScore (null if no games)
   - `worstRound`: `{ score, date }` with lowest totalScore (null if no games)
   - `scoreTrend`: array of `{ date, score }` sorted chronologically (oldest first) for trend visualization

4. `computeAllPlayerStats(games: HistoryRecord[]): PlayerStats[]` -- calls `getUniquePlayerNames` then maps through `computePlayerStats` for each, sorts by winRate desc then gamesPlayed desc.

Export the `PlayerStats` interface:
```typescript
export interface PlayerStats {
  displayName: string;
  gamesPlayed: number;
  wins: number;
  winRate: number;
  avgScore: number;
  bestRound: { score: number; date: string } | null;
  worstRound: { score: number; date: string } | null;
  scoreTrend: { date: string; score: number }[];
}
```

Import `HistoryRecord` from `@/lib/history-db`.

Create `src/hooks/use-player-stats.ts`:
- Import `useLiveQuery` from `dexie-react-hooks`, `historyDb` from `@/lib/history-db`, `computeAllPlayerStats` from `@/lib/stats`.
- Export `usePlayerStats(): PlayerStats[] | null` that wraps `useLiveQuery`:
  - Query: `historyDb.games.orderBy("completedAt").reverse().toArray()`
  - If `games.length === 0`, return `[]`
  - Otherwise return `computeAllPlayerStats(games)`
  - Default value: `null` (progressive enhancement pattern from Phase 5 -- null means "not yet loaded", empty array means "loaded but no data")
  </action>
  <verify>Run `npx tsc --noEmit` -- no type errors. Verify exports exist: `grep -n "export" src/lib/stats.ts src/hooks/use-player-stats.ts`.</verify>
  <done>stats.ts exports PlayerStats interface and all four functions (normalizePlayerName, getUniquePlayerNames, computePlayerStats, computeAllPlayerStats). use-player-stats.ts exports usePlayerStats hook that returns PlayerStats[] | null via useLiveQuery.</done>
</task>

<task type="auto">
  <name>Task 2: Build stats dashboard page with charts and navigation</name>
  <files>src/components/stats/player-stat-card.tsx, src/components/stats/win-rate-chart.tsx, src/app/stats/page.tsx, src/app/page.tsx, src/app/history/page.tsx</files>
  <action>
**Create `src/components/stats/player-stat-card.tsx`:**
A glass-card component that displays one player's stats. Props: `stats: PlayerStats`. Layout:
- Player name as heading (text-lg font-bold text-white)
- 4 stat cells in a 2x2 grid (grid-cols-2 gap-3):
  - Win Rate: Trophy icon (text-amber-400), value as `Math.round(winRate * 100)%`, subtitle `{wins} win(s) in {gamesPlayed} game(s)`
  - Avg Score: TrendingUp icon (text-emerald-400), value as `avgScore.toFixed(1)`, subtitle "per round"
  - Best Round: ArrowUp icon (text-emerald-400), value as bestRound score with `+` prefix if positive, subtitle with formatted date (or "--" if null)
  - Worst Round: ArrowDown icon (text-rose-400), value as worstRound score with `+` prefix if positive, subtitle with formatted date (or "--" if null)
- Each stat cell: `bg-slate-800/40 rounded-xl p-3` with icon + label row, large number, small subtitle
- Use Lucide icons: Trophy, TrendingUp, ArrowUp, ArrowDown
- Format dates as "MMM D" (e.g., "Feb 17") using `new Date(date).toLocaleDateString("en-US", { month: "short", day: "numeric" })`

**Create `src/components/stats/win-rate-chart.tsx`:**
A bar chart showing win rates across all players. Props: `data: { name: string; winRate: number; wins: number; games: number }[]`. Follow the exact ScoreTrendChart pattern from Phase 4:
- Use `ChartContainer` from `@/components/ui/chart` with a chartConfig defining `winRate` with color `hsl(142, 71%, 45%)` (emerald)
- Recharts `BarChart` with:
  - `CartesianGrid vertical={false} strokeDasharray="3 3" stroke="rgba(148, 163, 184, 0.15)"`
  - `XAxis dataKey="name"` with tickLine={false}, axisLine={false}, slate tick styling
  - `YAxis` with domain [0, 1], tickFormatter showing percentages, tickLine={false}, axisLine={false}
  - `ChartTooltip` with `ChartTooltipContent`
  - `Bar dataKey="winRate"` with fill `var(--color-winRate)`, radius `[4, 4, 0, 0]`
- Wrap in glass-card with "Win Rates" heading
- If data has fewer than 2 players, still render (single bar is fine for 1 player)

**Create `src/app/stats/page.tsx`:**
"use client" page with:
- Import and call `usePlayerStats()` hook
- Sticky header with back arrow (navigates to "/") and "Player Stats" title (same pattern as history page)
- Handle three states:
  1. `stats === null` -- render nothing (progressive enhancement, data loading)
  2. `stats.length === 0` -- empty state: golf emoji, "No games yet. Complete a round to see your stats.", "Start a Game" button linking to /setup (same pattern as history empty state)
  3. `stats.length > 0` -- render:
     - `WinRateChart` with data mapped from stats: `{ name: stats.displayName, winRate: stats.winRate, wins: stats.wins, games: stats.gamesPlayed }`
     - For each player in stats array: `PlayerStatCard` with the player's stats
- Use `max-w-lg mx-auto px-4 py-6 space-y-4` layout (matches history page)

**Update `src/app/page.tsx`:**
- Add a "View Stats" navigation link below the "View Game History" link
- Import `BarChart3` from lucide-react (the bar chart icon)
- Same styling as the "View Game History" button: `w-full h-12 rounded-xl text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-800/50 transition-all flex items-center justify-center gap-2`
- Show the link when `latestGame` is truthy (same condition as "View Game History" -- stats only make sense when games exist)
- onClick: `router.push("/stats")`

**Update `src/app/history/page.tsx`:**
- Add a "View Stats" link/button in the header area or below the game list
- Import `BarChart3` from lucide-react
- Add a button after the header, inside the `max-w-lg` container, before the games list: a glass-card style link that says "Player Stats" with the BarChart3 icon
- Only show when `games.length > 0`
- onClick: `router.push("/stats")`
  </action>
  <verify>Run `npm run build` -- build succeeds with no errors. Manually verify: navigate to /stats page renders without console errors. Home page shows "View Stats" link when games exist. History page shows stats link when games exist.</verify>
  <done>Stats dashboard at /stats shows per-player stat cards (win rate, avg score, best/worst round) and a win rate bar chart. Home page has "View Stats" link. History page has "Player Stats" link. Empty state shown when no games exist. All data is reactive via useLiveQuery.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes with no TypeScript or build errors
2. `npm run lint` passes
3. Navigate to /stats with no completed games -- see empty state message
4. Complete a game, navigate to /stats -- see stat cards for each player with correct win rate, avg score, best/worst
5. Complete a second game -- stats page shows updated numbers without manual refresh
6. Home page shows "View Stats" link when games exist
7. History page shows "Player Stats" link when games exist
</verification>

<success_criteria>
- /stats page renders per-player win rates, average scores, best/worst rounds from all saved games
- Win rate bar chart visualizes relative performance across players
- Stats auto-update via useLiveQuery when new games are saved
- Navigation to /stats is discoverable from both home page and history page
- Empty state is handled gracefully when no games exist
- No new npm dependencies required
</success_criteria>

<output>
After completion, create `.planning/phases/06-cross-round-statistics/06-01-SUMMARY.md`
</output>
